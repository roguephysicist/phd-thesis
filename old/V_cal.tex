\documentclass[a4paper,11pt]{report}

\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{calc}
\usepackage{array}
\usepackage{textcomp}
\usepackage[a4paper]{geometry}
\usepackage{graphicx}
\usepackage{lscape}
\usepackage{framed}
\usepackage{wrapfig}
\usepackage{booktabs}
\usepackage{amsfonts}
\usepackage{dsfont}

\def\tens#1{\protect\ontopof{#1}{\leftrightarrow}{1.15}{\textstyle}{\scriptscriptstyle}\mathord{\box2}}
\def\ontopof#1#2#3#4#5{%
\setbox0=\hbox{$#4#1$}%
\setbox1=\hbox{$#5#2$}%
\setbox2=\hbox{}\ht2=\ht0 \dp2=\dp0 %
\ifdim\wd0>\wd1 %
\setbox1=\hbox to\wd0{\hss\box1\hss}%
\mathord{\rlap{\raise#3\ht0\box1}\box0}%
\else   %
\setbox1=\hbox to.9\wd1{\hss\box1\hss}%
\setbox0=\hbox to\wd1{\hss$#4\relax#1$\hss}%
\mathord{\rlap{\copy0}\raise#3\ht0\box1}%
\fi
}

\geometry{lmargin=1.5cm}
\geometry{rmargin=1.5cm}
\geometry{tmargin=1.5cm}
 
\newenvironment{approximation}[1][Approximation : ]{\begin{trivlist}
\item[\hskip \labelsep {\bfseries #1}]}{\end{trivlist}}

\usepackage{titlesec}
% \titleformat{\chapter}[display]% OLD
%     {\normalfont\huge\bfseries}{\chaptertitlename\ \thechapter}{20pt}{\Huge}% OLD
% \titlespacing*{\chapter}{0pt}{50pt}{40pt}% OLD
\titleformat{\chapter}[display]% NEW
    {\fontfamily{ptm}\large\bfseries\centering}{\chaptertitlename\ \thechapter}{5pt}{\large}% NEW
\titlespacing*{\chapter}{0pt}{30pt}{20pt}% NEW
\renewcommand*\thesection{\arabic{section}}



\usepackage{color}
\newcommand{\red}[1]{\textcolor{red}{#1}}


\renewcommand{\vec}[1]{\mathbf{#1}}
\newcommand{\bra}{\langle}
\newcommand{\ket}{\rangle}

\begin{document}

\chapter{Matrix element of $\mathcal{V}$ in a plane-waves basis}

In a plane-waves basis, Bloch wavefunctions can be expressed as

\begin{equation}
 \phi_{n,\vec{k}}(\vec{r}) = \frac{e^{i\vec{k}\vec{r}}}{\sqrt{V}} \sum_{G} c_{n,\vec{k}}(\vec{G})e^{i\vec{G}\vec{r}}
\label{def_nk}
\end{equation}
where V is the volume of the unit-cell.\\
One wants to compute
\begin{eqnarray}
 \bra n,\vec{k}|\vec{q}\vec{\mathcal{V}}|n',\vec{k}\ket = \bra n,\vec{k}|\frac{\mathcal{C}(z)\vec{q}\vec{v}+\vec{q}\vec{v}\mathcal{C}(z)}{2}|n',\vec{k}\ket
\end{eqnarray}
with $\vec{v}=\vec{p}+i[V_{nl},\vec{r}]$.\\
One must computes the contributions 
$\bra n,\vec{k}|\frac{\mathcal{C}(z)\vec{q}\vec{p}+\vec{q}\vec{p}\mathcal{C}(z)}{2}|n',\vec{k}\ket$ and
$\bra n,\vec{k}|\frac{\mathcal{C}(z)[V_{nl},i\vec{q}\vec{r}]+[V_{nl},i\vec{q}\vec{r}]\mathcal{C}(z)}{2}|n',\vec{k}\ket$. \\

Using Eq.~\ref{def_nk}, 
\begin{eqnarray}
 \bra n,\vec{k}|\frac{\mathcal{C}(z)\vec{q}\vec{p}+\vec{q}\vec{p}\mathcal{C}(z)}{2}|n',\vec{k}\ket = \frac{-i}{2V}\sum_{\vec{G},\vec{G'}} c^*_{n,\vec{k}}(\vec{G})c_{n',\vec{k}}(\vec{G'}) \nonumber\\
\times\int d^3\vec{r} \Bigg[e^{-i(\vec{k}+\vec{G})\vec{r}} \mathcal{C}(z) \nabla_{\vec{r}} (e^{i(\vec{k}+\vec{G})\vec{r}}) - \nabla_{\vec{r}} (e^{-i(\vec{k}+\vec{G})\vec{r}} ) \mathcal{C}(z) e^{i(\vec{k}+\vec{G})\vec{r}}\Bigg]\nonumber\\
 = \frac{1}{2}\sum_{\vec{G},\vec{G'}} c^*_{n,\vec{k}}(\vec{G})c_{n',\vec{k}}(\vec{G'}) \left[2\vec{k}+\vec{G}+\vec{G'} \right]\frac{1}{V}\int d^3\vec{r} e^{-i(\vec{G}-\vec{G'})\vec{r}} \mathcal{C}(z)\nonumber\\
 = \frac{1}{2}\sum_{\vec{G},\vec{G'}} c^*_{n,\vec{k}}(\vec{G})c_{n',\vec{k}}(\vec{G'}) \left[2\vec{k}+\vec{G}+\vec{G'} \right] \delta_{\vec{G}_{||}\vec{G'}_{||}} F(G_z-G_z')
\end{eqnarray}
where we have defined $F(G_z)=\frac{1}{2L_z}\int dz e^{-iG_z z} \mathcal{C}(z)$.\\

In order to compute the term containing the commutator, we introduce the unity operator
\begin{equation}
 \bra n,\vec{k}|\mathcal{C}(z)[V_{nl},i\vec{q}\vec{r}]|n',\vec{k}\ket = 
\sum_{\vec{G''}}\bra n,\vec{k}|\mathcal{C}(z)|\vec{k}+\vec{G''}\ket\bra\vec{k}+\vec{G''}| [V_{nl},i\vec{q}\vec{r}]|n',\vec{k}\ket
\end{equation}
where $\bra \vec{r} |\vec{k}+\vec{G}\ket = e^{i(\vec{k}+\vec{G})\vec{r}}/\sqrt{V}$.\\
Using Eq.~\ref{def_nk}, 
\begin{eqnarray}
 \bra n,\vec{k}|\mathcal{C}(z)|\vec{k}+\vec{G''}\ket = \frac{1}{\sqrt{V}} \sum_{G} c^*_{n,\vec{k}}(\vec{G}) \int d^3\vec{r} e^{-i(\vec{k}+\vec{G})\vec{r}} \mathcal{C}(z)e^{i(\vec{k}+\vec{G''})\vec{r}}\nonumber\\
= \frac{1}{\sqrt{V}} \sum_{G} c^*_{n,\vec{k}}(\vec{G})\int d^3\vec{r} e^{-i(\vec{G}-\vec{G''})\vec{r}} \mathcal{C}(z) 
\end{eqnarray}
\begin{eqnarray}
 \bra\vec{k}+\vec{G''}| [V_{nl},i\vec{q}\vec{r}]|n',\vec{k}\ket = \frac{1}{\sqrt{V}} \sum_{G'} c_{n',\vec{k}}(\vec{G'})\int d^3\vec{r} e^{i(\vec{k}+\vec{G''})\vec{r}} [V_{nl},i\vec{q}\vec{r}] e^{i(\vec{k}+\vec{G'})\vec{r}} \nonumber\\
= \frac{1}{\sqrt{V}} \sum_{G'} c_{n',\vec{k}}(\vec{G'}) \bra \vec{k}+\vec{G''}| [V_{nl},i\vec{q}\vec{r}]|\vec{k}+\vec{G'}\ket
\end{eqnarray}
Putting everything together yields
\begin{equation}
 \bra n,\vec{k}|\mathcal{C}(z)[V_{nl},i\vec{q}\vec{r}]|n',\vec{k}\ket = 
\sum_{\vec{G},\vec{G'},\vec{G''}} c^*_{n,\vec{k}}(\vec{G})c_{n',\vec{k}}(\vec{G'}) \bra \vec{k}+\vec{G''}| [V_{nl},i\vec{q}\vec{r}]|\vec{k}+\vec{G'}\delta_{\vec{G}_{||}\vec{G''}_{||}} \ket F(G_z-G''_z)
\end{equation}

So 
\begin{eqnarray}
 \bra n,\vec{k}|\frac{\mathcal{C}(z)[V_{nl},i\vec{q}\vec{r}]+[V_{nl},i\vec{q}\vec{r}]\mathcal{C}(z)}{2}|n',\vec{k}\ket
= \sum_{\vec{G},\vec{G'},\vec{G''}} c^*_{n,\vec{k}}(\vec{G})c_{n',\vec{k}}(\vec{G'})\nonumber\\
\frac{1}{2}\Bigg[ \bra \vec{k}+\vec{G''}| [V_{nl},i\vec{q}\vec{r}]|\vec{k}+\vec{G'}\ket\delta_{\vec{G}_{||}\vec{G''}_{||}}  F(G_z-G''_z) + \bra \vec{k}+\vec{G}| [V_{nl},i\vec{q}\vec{r}]|\vec{k}+\vec{G''} \ket\delta_{\vec{G'}_{||}\vec{G''}_{||}} F(G''_z-G'_z) \Bigg]
\end{eqnarray}

We focus now on the special case of the non-local part of the pseudo-potential.\\
We have the relation
\begin{equation}
 i\bra \vec{K}|[V^{nl},\vec{r}]|\vec{K'}\ket=(\nabla_{\vec{K}}+\nabla_{\vec{K'}})\bra \vec{K}|V^{nl}|\vec{K'}\ket
\end{equation}
In case of a Kleinman-Bylander separable form pseudo-potential, we have
\begin{equation}
 \bra \vec{K}|V^{nl}|\vec{K'}\ket = \sum_s e^{i(\vec{K}-\vec{K'})\tau_s} \sum_{l=0}^{l_s}\sum_{m=-l}^{l}E_lF_{lm}^s(\vec{K})F_{lm}^{s*}(\vec{K'})
\end{equation}
So it comes that
\begin{eqnarray}
  \bra n,\vec{k}|[V^{nl},i\vec{r}]|n',\vec{k}\ket = \sum_s \sum_{l=0}^{l_s}\sum_{m=-l}^{l}E_l \sum_{\vec{G}\vec{G'}} c^*_{n,\vec{k}}(\vec{G})c_{n',\vec{k}}(\vec{G'}) e^{i(\vec{G}-\vec{G'})\tau_s} \nonumber\\
( \nabla_{\vec{G}}F_{lm}^s(\vec{G})F_{lm}^{s*}(\vec{G'}) + F_{lm}^s(\vec{G})\nabla_{\vec{G'}}F_{lm}^{s*}(\vec{G'}) ) \nonumber\\
= \sum_s \sum_{l=0}^{l_s}\sum_{m=-l}^{l}E_l \Bigg[ \Bigg(\sum_{\vec{G}}c^*_{n,\vec{k}}(\vec{G})e^{i(\vec{G})\tau_s}\nabla_{\vec{G}}F_{lm}^s(\vec{G})\Bigg)\Bigg(c_{n',\vec{k}}(\vec{G'}) e^{-i\vec{G'}}\tau_sF_{lm}^{s*}(\vec{G'})\Bigg) \nonumber\\
+  \Bigg(\sum_{\vec{G}}c^*_{n,\vec{k}}(\vec{G})e^{i\vec{G}\tau_s}F_{lm}^s(\vec{G})\Bigg)\Bigg(c_{n',\vec{k}}(\vec{G'}) e^{-i\vec{G'}}\tau_s\nabla_{\vec{G'}}F_{lm}^{s*}(\vec{G'})\Bigg) \Bigg]
\end{eqnarray}

\begin{eqnarray}
 \bra n,\vec{k}|\frac{\mathcal{C}(z)[V_{nl},i\vec{q}\vec{r}]+[V_{nl},i\vec{q}\vec{r}]\mathcal{C}(z)}{2}|n',\vec{k}\ket
= \sum_{\vec{G},\vec{G'},\vec{G''}} c^*_{n,\vec{k}}(\vec{G})c_{n',\vec{k}}(\vec{G'})\nonumber\\
\frac{1}{2}\Bigg[ (\nabla_{\vec{K''}}+\nabla_{\vec{K'}})\bra \vec{K''}|V^{nl}|\vec{K'}\ket \delta_{\vec{G}_{||}\vec{G''}_{||}}  F(G_z-G''_z) + (\nabla_{\vec{K}}+\nabla_{\vec{K''}})\bra \vec{K}|V^{nl}|\vec{K''}\ket\delta_{\vec{G'}_{||}\vec{G''}_{||}} F(G''_z-G'_z) \Bigg]\nonumber\\
\end{eqnarray}
Finally, we get
\begin{eqnarray}
 \bra n,\vec{k}|\frac{\mathcal{C}(z)[V_{nl},i\vec{q}\vec{r}]+[V_{nl},i\vec{q}\vec{r}]\mathcal{C}(z)}{2}|n',\vec{k}\ket
= \sum_s\sum_{l=0}^{l_s}\sum_{m=-l}^{l}E_l \nonumber\\
\frac{1}{2}\Bigg[ \Bigg(\sum_{\vec{G''}}e^{i\vec{G''}\tau_s} \nabla_{\vec{G''}}F_{lm}^s(\vec{G''}) \sum_{\vec{G}}c^*_{n,\vec{k}}(\vec{G})\delta_{\vec{G}_{||}\vec{G''}_{||}}  F(G_z-G''_z) \Bigg) 
\Bigg( \sum_{\vec{G'}}c_{n',\vec{k}}(\vec{G'})e^{-i\vec{G'}\tau_s}F_{lm}^{s*}(\vec{K'}) \Bigg) \nonumber\\
%
+ \Bigg(\sum_{\vec{G''}}e^{i\vec{G''}\tau_s} F_{lm}^s(\vec{G''})\sum_{\vec{G}}c^*_{n,\vec{k}}(\vec{G})\delta_{\vec{G}_{||}\vec{G''}_{||}}  F(G_z-G''_z) \Bigg)
\Bigg( \sum_{\vec{G'}}c_{n',\vec{k}}(\vec{G'})e^{-i\vec{G'}\tau_s}\nabla_{\vec{K'}}F_{lm}^{s*}(\vec{K'}) \Bigg)  \nonumber\\
+ \Bigg(\sum_{\vec{G}}c^*_{n,\vec{k}}(\vec{G})e^{i\vec{G}\tau_s}\nabla_{\vec{G}}F_{lm}^s(\vec{G})\Bigg)\Bigg( \sum_{\vec{G''}}e^{-i\vec{G''}\tau_s} F_{lm}^{s*}(\vec{G''})\sum_{\vec{G'}}c_{n',\vec{k}}(\vec{G'})\delta_{\vec{G'}_{||}\vec{G''}_{||}} F(G''_z-G'_z) \Bigg) \nonumber\\
+ \Bigg(\sum_{\vec{G}}c^*_{n,\vec{k}}(\vec{G})e^{i\vec{G}\tau_s}F_{lm}^s(\vec{G}) \Bigg) \Bigg( \sum_{\vec{G''}}e^{-i\vec{G''}\tau_s}\nabla_{\vec{G''}}F_{lm}^{s*}(\vec{G''}) \sum_{\vec{G'}}c_{n',\vec{k}}(\vec{G'})\delta_{\vec{G'}_{||}\vec{G''}_{||}} F(G''_z-G'_z) \Bigg) \Bigg]\nonumber\\
\end{eqnarray}



\end{document}