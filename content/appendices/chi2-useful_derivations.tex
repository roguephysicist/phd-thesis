%!TEX root = ../../main.tex
\chapter{Supplementary Derivations for the Nonlinear Surface Susceptibility}
\label{app:chi2deriv}
\partialtoc


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{\texorpdfstring{$\mathbf{r}_{e}$ and $\mathbf{r}_{i}$}{re and ri}}
\label{app:re_ri}

In this appendix, we derive the expressions for the matrix elements of the
electron position operator $\mathbf{r}$. The $r$ representation of the Bloch
states is given by
\begin{equation}\label{bloch}
\psi_{n\mathbf{k}}(\mathbf{r})=\langle\mathbf{r}\vert n\mathbf{k}\rangle =
\sqrt{\frac{\Omega}{8\pi^{3}}}
e^{i\mathbf{k} \cdot \mathbf{r}}u_{n\mathbf{k}}(\mathbf{r}),
\end{equation}
where $u_{n\mathbf{k}}(\mathbf{r}) = u_{n\mathbf{k}}(\mathbf{r} + \mathbf{R})$
is cell periodic, and
\begin{equation}\label{normal}
\int_{\Omega}
u_{n\mathbf{k}}^{*}(\mathbf{r})u_{m\mathbf{k}'}(\mathbf{r})\,d^{3}r
= \delta_{nm}\delta_{\mathbf{\mathbf{k},\mathbf{k}'}},
\end{equation}
and $\Omega$ is the unit cell volume.

The key ingredient in the calculation are the matrix elements of the position
operator $\mathbf{r}$. We start from the basic relation
\begin{equation}\label{nbraket}
\langle n\mathbf{k}\vert m\mathbf{k}'\rangle =
\delta_{nm}\delta(\mathbf{k} - \mathbf{k}'),
\end{equation}
and take its derivative with respect to $\mathbf{k}$ as follows. On one hand,
\begin{equation}\label{ddk1}
\frac{\partial}{\partial\mathbf{k}}
\langle n\mathbf{k}\vert m\mathbf{k}'\rangle =
\delta_{nm}\frac{\partial}{\partial\mathbf{k}}\delta(\mathbf{k} - \mathbf{k}'),
\end{equation}
and on the other,
\begin{equation}\label{dkbraket}
\frac{\partial}{\partial\mathbf{k}}\langle n\mathbf{k}\vert m\mathbf{k}'\rangle
= \frac{\partial}{\partial\mathbf{k}}\int
\langle n\mathbf{k}\vert \mathbf{r}\rangle
\langle \mathbf{r}\vert m\mathbf{k}'\rangle
\,d\mathbf{r} 
= \int
\left(
\frac{\partial}{\partial\mathbf{k}}
\psi^{*}_{n\mathbf{k}}(\mathbf{r})
\right)
\psi_{m\mathbf{k}'}(\mathbf{r})\,d\mathbf{r}.
\end{equation}
The derivative of the wavefunction is simply given by
\begin{equation}\label{dpsi}
\frac{\partial}{\partial\mathbf{k}}\psi^{*}_{n\mathbf{k}}(\mathbf{r})
= \sqrt{\frac{\Omega}{8\pi^{3}}}
\left(
\frac{\partial}{\partial\mathbf{k}}
u^{*}_{n\mathbf{k}}(\mathbf{r})
\right)
e^{-i\mathbf{k}\cdot\mathbf{r}} - i\mathbf{r}\psi^{*}_{n\mathbf{k}}(\mathbf{r}).
\end{equation}
Substituting into Eq. \eqref{dkbraket}, we obtain
\begin{align}\label{dkbraket2}
\frac{\partial}{\partial\mathbf{k}}\langle n\mathbf{k}\vert m\mathbf{k}'\rangle
&= \sqrt{\frac{\Omega}{8\pi^{3}}}\int
\left(
\frac{\partial}{\partial\mathbf{k}}
u^{*}_{n\mathbf{k}}(\mathbf{r})\right)e^{-i\mathbf{k}\cdot\mathbf{r}}
\psi_{m\mathbf{k}'}(\mathbf{r})\,d\mathbf{r} 
- i\int\psi^{*}_{n\mathbf{k}}(\mathbf{r})\mathbf{r}
  \psi_{m\mathbf{k}'}(\mathbf{r})\,d\mathbf{r}\nonumber \\
&= \frac{\Omega}{8\pi^{3}}\int
  e^{-i(\mathbf{k}-\mathbf{k}')\cdot\mathbf{r}}
  \left(
  \frac{\partial}{\partial\mathbf{k}}u^{*}_{n\mathbf{k}}(\mathbf{r})
  \right)
u_{m\mathbf{k}'}(\mathbf{r})\,d\mathbf{r}
- i \langle n\mathbf{k}\vert\hat{\mathbf{r}}\vert m\mathbf{k}'\rangle.
\end{align}
Restricting $\mathbf{k}$ and $\mathbf{k}'$ to the first Brillouin zone, we use
the following result that is valid for any periodic function
$f(\mathbf{r}) = f(\mathbf{r} + \mathbf{R})$,
\begin{align}\label{periodic}
\int e^{i(\mathbf{q}-\mathbf{k})\cdot\mathbf{r}}f(\mathbf{r})\,d^{3}r =
\frac{8\pi^{3}}{\Omega}\delta(\mathbf{q} - \mathbf{k})
\int_{\Omega}f(\mathbf{r})\,d^{3}r,
\end{align}
to finally write \cite{blountSSP62}
\begin{align}\label{dkbraket3}
\frac{\partial}{\partial\mathbf{k}}
\langle n\mathbf{k}\vert m\mathbf{k}'\rangle
&= \delta(\mathbf{k}-\mathbf{k}')\int_{\Omega}
\left(
\frac{\partial}{\partial\mathbf{k}} u^{*}_{n\mathbf{k}}(\mathbf{r})
\right)
u_{m\mathbf{k}}(\mathbf{r})\,d\mathbf{r}
-i\langle n\mathbf{k}\vert\hat{\mathbf{r}}\vert m\mathbf{k}'\rangle.
\end{align}
From
\begin{align}\label{dnm1}
\int_{\Omega}u_{m\mathbf{k}} u^{*}_{n\mathbf{k}}\,d\mathbf{r} = \delta_{nm},
\end{align}
we easily find that
\begin{align}\label{dnm2}
\int_{\Omega}
\left(
\frac{\partial}{\partial\mathbf{k}} u_{m\mathbf{k}}(\mathbf{r})
\right)
u^{*}_{n\mathbf{k}}(\mathbf{r})\,d\mathbf{r}
= -\int_{\Omega}u_{m\mathbf{k}}(\mathbf{r})
\left(
\frac{\partial}{\partial\mathbf{k}} u^{*}_{n\mathbf{k}}(\mathbf{r})
\right)\,d\mathbf{r}.
\end{align}
Therefore, we define
\begin{align}\label{zeta}
\boldsymbol{\xi}_{nm}(\mathbf{k}) \equiv
i\int_{\Omega}u^{*}_{n\mathbf{k}}(\mathbf{r})\nabla_{\mathbf{k}}
u_{m\mathbf{k}}(\mathbf{r})\,d\mathbf{r},
\end{align} 
with $\nabla_{\mathbf{k}} = \partial/\partial\mathbf{k}$. Now, from Eqs.
\eqref{ddk1}, \eqref{dkbraket2}, and  \eqref{zeta}, we have that the matrix
elements of the position operator of the electron are given by
\begin{align}\label{erre}
\langle n\mathbf{k}\vert \hat{\mathbf{r}} \vert m\mathbf{k}'\rangle 
= \delta(\mathbf{k}-\mathbf{k}')\boldsymbol{\xi}_{nm}(\mathbf{k})
+ i\delta_{nm}\nabla_{\mathbf{k}}\delta(\mathbf{k}-\mathbf{k}'),
\end{align}
Then, from Eq. \eqref{erre} and writing $\hat{\mathbf{r}} = \hat{\mathbf{r}}_{e}
+ \hat{\mathbf{r}}_{i}$, with $\hat{\mathbf{r}}_{e}$ ($\hat{\mathbf{r}}_{i}$)
the interband (intraband) part, we obtain that
\begin{align}\label{rnmi}
\langle n\mathbf{k}\vert \hat{\mathbf{r}}_{i} \rangle m\mathbf{k}'\vert
&= \delta_{nm}
\left[
  \delta(\mathbf{k}-\mathbf{k}')\boldsymbol{\xi}_{nn}(\mathbf{k})
+ i\nabla_{\mathbf{k}}\delta(\mathbf{k} - \mathbf{k}')
\right],\\
\langle n\mathbf{k}\vert \hat{\mathbf{r}}_e \rangle m\mathbf{k}'\vert
&= (1 - \delta_{nm})\delta(\mathbf{k}-\mathbf{k}')
   \boldsymbol{\xi}_{nm}(\mathbf{k}).
\label{rnme}
\end{align} 

To proceed, we relate Eq. \eqref{rnme} to the matrix elements of the momentum
operator as follows. For the intraband part, we derive the following general
result,
\begin{equation}\label{conmri}
\begin{split}
\langle n\mathbf{k}\vert
\left[\hat{\mathbf{r}}_{i},\hat{\mathcal{O}}\right]
\vert m\mathbf{k}'\rangle
&= \sum_{\ell,\mathbf{k}''}
\left(
\langle n\mathbf{k}\vert\hat{\mathbf{r}}_{i}\vert\ell\mathbf{k}''\rangle
\langle\ell\mathbf{k}''\vert\hat{\mathcal{O}}\vert m\mathbf{k}'\rangle
-
\langle n\mathbf{k}\vert\hat{\mathcal{O}}\vert\ell\mathbf{k}''\rangle
\langle\ell\mathbf{k}''\vert\hat{\mathbf{r}}_{i}\vert m\mathbf{k}'\rangle
\right)\\
&=
\sum_{\ell}
\left(
\langle n\mathbf{k}\vert\hat{\mathbf{r}}_{i}\vert \ell\mathbf{k}'\rangle
\mathcal{O}_{\ell m}(\mathbf{k}')
-
\mathcal{O}_{n\ell}(\mathbf{k})
\vert \ell\mathbf{k}\rangle\langle \ell\mathbf{k}\vert\hat{\mathbf{r}}_{i}
\vert m\mathbf{k}'\rangle
\right),
\end{split}
\end{equation}
where we have taken $\langle
n\mathbf{k}\vert\hat{\mathcal{O}}\vert\ell\mathbf{k}''\rangle =
\delta(\mathbf{k} - \mathbf{k}'')\mathcal{O}_{n\ell}(\mathbf{k})$. We substitute
Eq. \eqref{rnmi} to obtain
\begin{align}\label{conmri2}
\sum_{\ell}&
\left(
\delta_{n\ell}[
  \delta(\mathbf{k}-\mathbf{k}')\boldsymbol{\xi}_{nn}(\mathbf{k})
+ i\nabla_{\mathbf{k}}\delta(\mathbf{k}-\mathbf{k}')
]\mathcal{O}_{\ell m}(\mathbf{k}')
- \mathcal{O}_{n\ell}(\mathbf{k})\delta_{\ell m}
\left[
  \delta(\mathbf{k}-\mathbf{k}')\boldsymbol{\xi}_{mm}(\mathbf{k})
+ i\nabla_{\mathbf{k}}\delta(\mathbf{k}-\mathbf{k}')
\right]
\right)\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&=
\left(
\left[
\delta(\mathbf{k}-\mathbf{k}')\boldsymbol{\xi}_{nn}(\mathbf{k})
+ i\nabla_{\mathbf{k}}\delta(\mathbf{k}-\mathbf{k}')
\right]
\mathcal{O}_{n m}(\mathbf{k}')
- \mathcal{O}_{nm}(\mathbf{k})
\left[
  \delta(\mathbf{k}-\mathbf{k}')\boldsymbol{\xi}_{mm}(\mathbf{k})
+ i\nabla_{\mathbf{k}}\delta(\mathbf{k}-\mathbf{k}')
\right]
\right)\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&= \delta(\mathbf{k}-\mathbf{k}')\mathcal{O}_{nm}(\mathbf{k})
\left(
\boldsymbol{\xi}_{nn}(\mathbf{k})-\boldsymbol{\xi}_{mm}(\mathbf{k})
\right)
+ i\mathcal{O}_{n m}(\mathbf{k}')\nabla_{\mathbf{k}}
  \delta(\mathbf{k}-\mathbf{k}')
+ i\delta(\mathbf{k}-\mathbf{k}')\nabla_{\mathbf{k}}
  \mathcal{O}_{n m}(\mathbf{k})
- i\mathcal{O}_{n m}(\mathbf{k}')\nabla_{\mathbf{k}}
  \delta(\mathbf{k}-\mathbf{k}')\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&=
i\delta(\mathbf{k}-\mathbf{k}')
\big(
\nabla_{\mathbf{k}}\mathcal{O}_{nm}(\mathbf{k}) - i\mathcal{O}_{nm}(\mathbf{k})
\left(
\boldsymbol{\xi}_{nn}(\mathbf{k}) - \boldsymbol{\xi}_{mm}(\mathbf{k})
\right)
\big)\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&\equiv i\delta(\mathbf{k}-\mathbf{k}')(\mathcal{O}_{nm})_{;\mathbf{k}}.
\end{align}
Then,
\begin{equation}\label{conmri3}
\langle n\mathbf{k}\vert
[\hat{\mathbf{r}}_{i},\hat{\mathcal{O}}]\vert m\mathbf{k}'\rangle
= i\delta(\mathbf{k}-\mathbf{k}')(\mathcal{O}_{nm})_{;\mathbf{k}},
\end{equation}   
where
\begin{equation}\label{gendev}
(\mathcal{O}_{nm})_{;\mathbf{k}}=
\nabla_{\mathbf{k}}\mathcal{O}_{nm}(\mathbf{k}) - i\mathcal{O}_{nm}(\mathbf{k})
\left(
\boldsymbol{\xi}_{nn}(\mathbf{k}) - \boldsymbol{\xi}_{mm}(\mathbf{k})
\right),
\end{equation}  
is the generalized derivative of $\mathcal{O}_{nm}$ with respect to
$\mathbf{k}$. Note that the highly singular term
$\nabla_{\mathbf{k}}\delta(\mathbf{k}-\mathbf{k}')$ cancels in Eq.
\eqref{conmri2}, thus giving a well defined commutator of the intraband position
operator with any arbitrary operator $\hat{\mathcal{O}}$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Matrix elements of
\texorpdfstring{$\mathbf{v}^\mathrm{nl}_{nm}(\mathbf{k})$}{vnl} and 
\texorpdfstring{$\boldsymbol{\mathcal{V}}^{\mathrm{nl},\ell}_{nm}(\mathbf{k})$}
{calVnl}}
\label{app:vnlme}

From Eq. \eqref{conhr}, we have that
\begin{align}\label{vnln.0}
\mathbf{v}^\mathrm{nl}_{nm}(\mathbf{k})
 = \langle n\mathbf{k}\vert\hat{\mathbf{v}}^\mathrm{nl}\vert m\mathbf{k}'\rangle
&= \frac{i}{\hbar}\langle n\mathbf{k}\vert
   \left[\hat{V}^\mathrm{nl},\hat{\mathbf{r}}\right]
   \vert m\mathbf{k}'\rangle\nonumber\\
&= \frac{i}{\hbar}\int
   \langle n\mathbf{k}\vert\mathbf{r}\rangle
   \langle\mathbf{r}\vert
   \left[\hat{V}^\mathrm{nl},\hat{\mathbf{r}}\right]
   \vert\mathbf{r}'\rangle
   \langle\mathbf{r}'\vert m\mathbf{k}'\rangle
   \,d\mathbf{r}\,d\mathbf{r}'\nonumber\\
&= \frac{i}{\hbar}\delta(\mathbf{k}-\mathbf{k}')\int 
   \psi^{*}_{n\mathbf{k}}(\mathbf{r})
   \langle\mathbf{r}\vert
   \left[\hat{V}^\mathrm{nl},\hat{\mathbf{r}}\right]
   \vert\mathbf{r}'\rangle
   \psi_{m\mathbf{k}'}(\mathbf{r}')
   \,d\mathbf{r}\,d\mathbf{r}',
\end{align}   
where $\mathbf{k}=\mathbf{k}'$ due to the fact that the integrand is periodic in
real space, and $\mathbf{k}$ is restricted to the Brillouin Zone. Now,
\begin{align}\label{vnln.1}
\langle\mathbf{r}\vert
\left[\hat{V}^\mathrm{nl},\hat{\mathbf{r}}\right]
\vert\mathbf{r}'\rangle
&= \langle\mathbf{r}\vert\hat{V}^\mathrm{nl}\hat{\mathbf{r}}
   - \hat{\mathbf{r}}\hat{V}^\mathrm{nl}\vert\mathbf{r}'\rangle
 = \langle\mathbf{r}\vert
   \hat{V}^\mathrm{nl}\hat{\mathbf{r}}
   \vert\mathbf{r}'\rangle
   - \langle\mathbf{r}\vert
     \hat{\mathbf{r}}\hat{V}^\mathrm{nl}
     \vert\mathbf{r}'\rangle\nonumber\\
&= \langle\mathbf{r}\vert\hat{V}^\mathrm{nl} \mathbf{r}'\vert\mathbf{r}'\rangle
   - \langle\mathbf{r}\vert\mathbf{r}\hat{V}^\mathrm{nl}\vert\mathbf{r}'\rangle
 = \langle\mathbf{r}\vert\hat{V}^\mathrm{nl}\vert\mathbf{r}'\rangle
   (\mathbf{r}'-\mathbf{r})
 = V^\mathrm{nl}(\mathbf{r},\mathbf{r}')(\mathbf{r}'-\mathbf{r}),
\end{align}
where we used $\hat{r}\langle\mathbf{r}\vert = r\langle\mathbf{r}\vert$,
$\langle\mathbf{r}'\vert\hat{r} = \langle\mathbf{r}\vert r'$, and
$V^\mathrm{nl}(\mathbf{r},\mathbf{r}') =
\langle\mathbf{r}\vert\hat{V}^\mathrm{nl}\vert\mathbf{r}'\rangle$
(Eq. \eqref{ache.3n}). Also, we have the following identity which will be used
shortly,
\begin{align}\label{cn51}
(\nabla_\mathbf{K}+\nabla_{\mathbf{K}'})\frac{1}{\Omega}\int e^{-i\mathbf{K}\cdot\mathbf{r}}V^\mathrm{nl}(\mathbf{r},\mathbf{r}')e^{i\mathbf{K}'\cdot\mathbf{r}'}\,d\mathbf{r}\,d\mathbf{r}'
&= -i \frac{1}{\Omega} \int e^{-i\mathbf{K}\cdot\mathbf{r}} \left(\mathbf{r} V^\mathrm{nl}(\mathbf{r},\mathbf{r}') - V^\mathrm{nl}(\mathbf{r},\mathbf{r}') \mathbf{r}'\right) e^{i\mathbf{K}'\cdot\mathbf{r}'} \,d\mathbf{r}\,d\mathbf{r}'\nonumber\\ (\nabla_\mathbf{K}+\nabla_{\mathbf{K}'}) \langle\mathbf{K}\vert V^\mathrm{nl} \vert\mathbf{K}'\rangle
&= \frac{i}{\Omega} \int e^{-i\mathbf{K}\cdot\mathbf{r}} V^\mathrm{nl}(\mathbf{r},\mathbf{r}') \big(\mathbf{r}'- \mathbf{r} \big) e^{i\mathbf{K}'\cdot\mathbf{r}'} \,d\mathbf{r}\,d\mathbf{r}',
\end{align}
where $\Omega$ is the volume of the unit cell, and we defined
\begin{align}\label{cn52}
V^\mathrm{nl}(\mathbf{K},\mathbf{K}') 
\equiv
\langle\mathbf{K}\vert V^\mathrm{nl} \vert\mathbf{K}'\rangle
= \frac{1}{\Omega} \int e^{-i\mathbf{K}\cdot\mathbf{r}} V^\mathrm{nl}(\mathbf{r},\mathbf{r}') e^{i\mathbf{K}'\cdot\mathbf{r}'} \,d\mathbf{r}\,d\mathbf{r}',
\end{align}
where 
$V^\mathrm{nl}(\mathbf{K}',\mathbf{K}) =V^{\mathrm{nl} *}(\mathbf{K},\mathbf{K}')$, since $V^\mathrm{nl}(\mathbf{r}',\mathbf{r})=V^{\mathrm{nl}*}(\mathbf{r},\mathbf{r}')$ due to the fact that $\hat V^\mathrm{nl}$ is a hermitian operator. Using the plane wave expansion
\begin{align}\label{cn3}
\langle\mathbf{r}\vert n\mathbf{k}\rangle=\psi_{n\mathbf{k}}(\mathbf{r})=\frac{1}{\sqrt{\Omega}} \sum_{\mathbf{G}} A_{n\mathbf{k}}(\mathbf{G})e^{i\mathbf{K}\cdot\mathbf{r}} ,
\end{align}
with $\mathbf{K}=\mathbf{k}+\mathbf{G}$, we obtain from Eq. \eqref{vnln.0} and Eq. \eqref{cn51}, that
\begin{align}\label{vnln.2}
\mathbf{v}^\mathrm{nl}_{nm}(\mathbf{k})
&= \frac{i}{\hbar} \delta(\mathbf{k}-\mathbf{k}') \sum_{\mathbf{G},\mathbf{G}'} A^{*}_{n\mathbf{k}}(\mathbf{G}) A_{m\mathbf{k}'}(\mathbf{G}') \frac{1}{\Omega} \int d\mathbf{r}\,d\mathbf{r}'e^{-i\mathbf{K}\cdot\mathbf{r}} \langle\mathbf{r}\vert [\hat{V}^\mathrm{nl},\hat{\mathbf{r}}] \vert\mathbf{r}'\rangle e^{i\mathbf{K}'\cdot\mathbf{r}'} \nonumber\\ 
&= \frac{1}{\hbar} \delta(\mathbf{k}-\mathbf{k}') \sum_{\mathbf{G},\mathbf{G}'} A^{*}_{n\mathbf{k}}(\mathbf{G}) A_{m\mathbf{k}'}(\mathbf{G}') \frac{i}{\Omega} \int d\mathbf{r}\,d\mathbf{r}'e^{-i\mathbf{K}\cdot\mathbf{r}} V^\mathrm{nl}(\mathbf{r},\mathbf{r}') \big(\mathbf{r}'-\mathbf{r}\big) e^{i\mathbf{K}'\cdot\mathbf{r}'} \nonumber\\
&= \frac{1}{\hbar} \delta(\mathbf{k}-\mathbf{k}') \sum_{\mathbf{G},\mathbf{G}'} A^{*}_{n\mathbf{k}}(\mathbf{G}) A_{m\mathbf{k}'}(\mathbf{G}') (\nabla_\mathbf{K}+\nabla_{\mathbf{K}'}) V^\mathrm{nl}(\mathbf{K},\mathbf{K}') .
\end{align}  

For fully  separable pseudopotentials in the Kleinman-Bylander (KB) form,\cite{mottaCMS10,kleinmanPRL82,adolphPRB96} the matrix elements $\langle\mathbf{K}\vert V^\mathrm{nl} \vert\mathbf{K}'\rangle =V^\mathrm{nl}(\mathbf{K},\mathbf{K}') $ can be readily calculated. \cite{mottaCMS10} Indeed, the Fourier representation assumes the form,\cite{adolphPRB96,gordienkoRPJ04,fuchsCPC99}
\begin{align}\label{ji.1} 
V^\mathrm{nl}_{\mathrm{KB}}(\mathbf{K},\mathbf{K}')  
 &= 
\sum_s e^{i(\mathbf{K}-\mathbf{K}')\cdot\boldsymbol{\tau}_s}
\sum_{l=0}^{l_s}\sum_{m=-l}^{l}E_lF_{lm}^s(\mathbf{K})F_{lm}^{s*}(\mathbf{K}')  
\nonumber\\
 &= 
\sum_s 
\sum_{l=0}^{l_s}\sum_{m=-l}^{l}E_lf_{lm}^s(\mathbf{K})f_{lm}^{s*}(\mathbf{K}')  
,
\end{align} 
with $f^s_{lm}(\mathbf{K})=e^{i\mathbf{K}\cdot\boldsymbol{\tau}_s}F^s_{lm}(\mathbf{K})$, and
\begin{align}\label{ji.2}
F^s_{lm}(\mathbf{K})=\int d\mathbf{r}\,e^{-i\mathbf{K}\cdot\mathbf{r}}
\delta V^S_l(\mathbf{r})
\Phi^\mathrm{ps}_{lm}(\mathbf{r}) 
.
\end{align}
Here $\delta V^S_l(\mathbf{r})$ is the non-local contribution of the ionic
pseudopotential centered at the atomic position $\boldsymbol{\tau}_s$ located in
the unit cell, 
$\Phi^\mathrm{ps}_{lm}(\mathbf{r})$ is the pseudo-wavefunction of the corresponding
atom, while $E_l$ is the so called 
Kleinman-Bylander energy. Further details can be found in
Ref. \cite{fuchsCPC99}.
From Eq. \eqref{ji.1} we find
\begin{align}\label{ji.1n}
(\nabla_\mathbf{K}+\nabla_{\mathbf{K}'})  
V^\mathrm{nl}_{\mathrm{KB}}(\mathbf{K},\mathbf{K}') 
 &= 
\sum_s 
\sum_{l=0}^{l_s}\sum_{m=-l}^{l}E_l 
(\nabla_\mathbf{K}+\nabla_{\mathbf{K}'})   
f_{lm}^s (\mathbf{K})f_{lm}^{s*}(\mathbf{K}') 
\nonumber\\
 &= 
\sum_s 
\sum_{l=0}^{l_s}\sum_{m=-l}^{l}E_l 
\left(\left[\nabla_\mathbf{K} f_{lm}^s (\mathbf{K})\right]f_{lm}^{s*}(\mathbf{K}') 
+
f_{lm}^s (\mathbf{K}) \left[\nabla_{\mathbf{K}'}  f_{lm}^{s*}(\mathbf{K}') \right]
\right),
\end{align}
and using this in Eq. \eqref{vnln.2} leads to
\begin{align}\label{forg}
\mathbf{v}^\mathrm{nl}_{nm}(\mathbf{k})
&=
\frac{1}{\hbar}
\sum_s
\sum_{l=0}^{l_s}\sum_{m=-l}^{l}E_l \sum_{\mathbf{G}\mathbf{G}'}
A^{*}_{n,\vec{k}}(\mathbf{G})A_{n',\vec{k}}(\mathbf{G}')
\times
( \nabla_{\mathbf{K}}f_{lm}^s(\mathbf{K})f_{lm}^{s*}(\mathbf{K}') +
f_{lm}^s(\mathbf{K})\nabla_{\mathbf{K}'}f_{lm}^{s*}(\mathbf{K}') ) \nonumber\\
&
=\frac{1}{\hbar}
 \sum_s \sum_{l=0}^{l_s}\sum_{m=-l}^{l}E_l \Bigg[
\Bigg(\sum_{\mathbf{G}}A^{*}_{n,\vec{k}}(\mathbf{G})\nabla_{\mathbf{K}}f_{lm}^s(\mathbf{K})\Bigg)
\Bigg(\sum_{\mathbf{G}'}A_{n',\vec{k}}(\mathbf{G}')
f_{lm}^{s*}(\mathbf{K}')\Bigg) \nonumber\\
&\qquad\qquad\qquad\qquad\qquad+
\Bigg(\sum_{\mathbf{G}}A^{*}_{n,\vec{k}}(\mathbf{G})
f_{lm}^s(\mathbf{K})\Bigg)\Bigg
(\sum_{\mathbf{G}'}A_{n',\vec{k}}(\mathbf{G}')
\nabla_{\mathbf{K}'}f_{lm}^{s*}(\mathbf{K}')\Bigg) \Bigg]
,
\end{align}
where there are only single sums over $\mathbf{G}$. Above is implemented in the
DP code \cite{olevanoDP}.

Now we derive $\boldsymbol{\mathcal{V}}^{\mathrm{nl},\ell}_{nm}(\mathbf{k})$. First we prove that
\begin{align}\label{cvnl.1}
\sum_{\mathbf{G}}
\vert\mathbf{k}+\mathbf{G}\rangle\langle\mathbf{k}+\mathbf{G}\vert
=1
.
\end{align}
\noindent Proof:
\begin{align}\label{cvnl.2}
\langle n\mathbf{k}\vert 1\vert n'\mathbf{k}\rangle=\delta_{nn'}
,
\end{align}
take
\begin{align}\label{cvnl.3}
\sum_\mathbf{G} \langle n\mathbf{k}\vert \vert\mathbf{k}+\mathbf{G}\rangle\langle\mathbf{k}+\mathbf{G}\vert\vert n'\mathbf{k}\rangle
&=
\int d\mathbf{r}\,d\mathbf{r}' 
\sum_\mathbf{G} \langle n\mathbf{k}\vert 
\vert\mathbf{r}\rangle\langle\mathbf{r}\vert
\vert\mathbf{k}+\mathbf{G}\rangle\langle\mathbf{k}+\mathbf{G}\vert
\vert\mathbf{r}'\rangle\langle\mathbf{r}'\vert
\vert n'\mathbf{k}\rangle
\nonumber\\
&=
\int d\mathbf{r}\,d\mathbf{r}' 
\sum_\mathbf{G} 
\psi^{*}_{n\mathbf{k}}(\mathbf{r}) 
\frac{1}{\sqrt{\Omega}}e^{i(\mathbf{k}+\mathbf{G})\cdot\mathbf{r}}
\frac{1}{\sqrt{\Omega}}e^{-i(\mathbf{k}+\mathbf{G})\cdot\mathbf{r}'}
\psi_{m\mathbf{k}}(\mathbf{r}') 
\nonumber\\
&=
\int d\mathbf{r}\,d\mathbf{r}' 
\psi^{*}_{n\mathbf{k}}(\mathbf{r}) 
\psi_{m\mathbf{k}}(\mathbf{r}') 
\frac{1}{V}
\sum_\mathbf{G} 
e^{i(\mathbf{k}+\mathbf{G})\cdot(\mathbf{r}-\mathbf{r}')}
\nonumber\\
&=
\int d\mathbf{r}\,d\mathbf{r}' 
\psi^{*}_{n\mathbf{k}}(\mathbf{r}) 
\psi_{m\mathbf{k}}(\mathbf{r}') 
\delta(\mathbf{r}-\mathbf{r}')
=
\int d\mathbf{r}
\psi^{*}_{n\mathbf{k}}(\mathbf{r}) 
\psi_{m\mathbf{k}}(\mathbf{r})=\delta_{nn'} ,
\end{align}
and thus Eq. \eqref{cvnl.1} follows. We used
\begin{align}\label{vnl.4}
\langle\mathbf{r}\vert\mathbf{k}+\mathbf{G}\rangle=\frac{1}{\sqrt{\Omega}}e^{i(\mathbf{k}+\mathbf{G})\cdot\mathbf{r}}.
\end{align}

From Eq. \eqref{nl.4}, we would like to calculate
\begin{align}\label{vnl.5}
\boldsymbol{\mathcal{V}}^{\mathrm{nl},\ell}_{nm}(\mathbf{k})=\frac{1}{2}
\langle n\mathbf{k}\vert  
C^{\ell}(z)\mathbf{v}^\mathrm{nl}+\mathbf{v}^\mathrm{nl} C^{\ell}(z)  
\vert m\mathbf{k}\rangle.
\end{align}  
We work out the first term on the right hand side,
\begin{align}\label{vnl.6}
\langle n\mathbf{k}\vert C^{\ell}(z) 
\mathbf{v}^\mathrm{nl}\vert m\mathbf{k}\rangle
&=\sum_{\mathbf{G}}
\langle n\mathbf{k}\vert C^{\ell}(z)\vert\mathbf{k}+\mathbf{G}\rangle
\langle\mathbf{k}+\mathbf{G}\vert\mathbf{v}^\mathrm{nl}\vert m\mathbf{k}\rangle
\nonumber\\
&=\sum_{\mathbf{G}}
\int d\mathbf{r} 
\int d\mathbf{r}' 
\langle n\mathbf{k}\vert 
\vert\mathbf{r}\rangle\langle\mathbf{r}\vert  
C^{\ell}(z) 
\vert\mathbf{r}'\rangle\langle\mathbf{r}'\vert
\vert\mathbf{k}+\mathbf{G}\rangle
\times 
\int d\mathbf{r}'' 
\int d\mathbf{r}''' 
\langle\mathbf{k}+\mathbf{G}\vert
\vert\mathbf{r}''\rangle\langle\mathbf{r}''\vert 
\mathbf{v}^\mathrm{nl} 
\vert\mathbf{r}'''\rangle\langle\mathbf{r}'''\vert
\vert m\mathbf{k}\rangle
\nonumber\\
&=\sum_{\mathbf{G}}
\int d\mathbf{r} 
\int d\mathbf{r}' 
\langle n\mathbf{k}\vert\mathbf{r}\rangle
C^{\ell}(z) 
\delta(\mathbf{r}-\mathbf{r}') 
\langle\mathbf{r}'\vert\mathbf{k}+\mathbf{G}\rangle
\times 
\int d\mathbf{r}'' 
\int d\mathbf{r}''' 
\langle\mathbf{k}+\mathbf{G}\vert\mathbf{r}''\rangle
\langle\mathbf{r}''\vert
\mathbf{v}^\mathrm{nl} 
\vert\mathbf{r}'''\rangle
\langle\mathbf{r}'''\vert m\mathbf{k}\rangle
\nonumber\\
&=\sum_{\mathbf{G}}
\int d\mathbf{r} 
\langle n\mathbf{k}\vert\mathbf{r}\rangle
C^{\ell}(z) 
\langle\mathbf{r}\vert\mathbf{k}+\mathbf{G}\rangle
\times 
\frac{i}{\hbar}
\int d\mathbf{r}'' 
\int d\mathbf{r}''' 
\langle\mathbf{k}+\mathbf{G}\vert\mathbf{r}''\rangle
V^\mathrm{nl}(\mathbf{r}'',\mathbf{r}''')(\mathbf{r}'''-\mathbf{r}'') 
\langle\mathbf{r}'''\vert m\mathbf{k}\rangle
,
\end{align}
where we used Eq. \eqref{vnln.1} and \eqref{conhr}. 
We use Eq. \eqref{cn3}, \eqref{vnl.4} and \eqref{cn51}  to obtain
\begin{align}\label{vnl.7}
\langle n\mathbf{k}\vert C^{\ell}(z) 
\mathbf{v}^\mathrm{nl}\vert m\mathbf{k}\rangle
&=\sum_{\mathbf{G}}
\sum_{\mathbf{G}'}
A^{*}_{n\mathbf{k}}(\mathbf{G}') 
\frac{1}{\Omega}
\int d\mathbf{r} 
e^{-i(\mathbf{k}+\mathbf{G}')\cdot\mathbf{r}}
C^{\ell}(z) 
e^{i(\mathbf{k}+\mathbf{G})\cdot\mathbf{r}}
\nonumber\\
&\times 
\sum_{\mathbf{G}''}
A_{m\mathbf{k}}(\mathbf{G}'') 
\frac{i}{\hbar\Omega}
\int d\mathbf{r}'' 
\int d\mathbf{r}''' 
e^{-i(\mathbf{k}+\mathbf{G})\cdot\mathbf{r}''} 
V^\mathrm{nl}(\mathbf{r}'',\mathbf{r}''')(\mathbf{r}'''-\mathbf{r}'') 
e^{i(\mathbf{k}+\mathbf{G}'')\cdot\mathbf{r}'''}
\nonumber\\
&=
\frac{1}{\hbar}
\sum_{\mathbf{G}}
\sum_{\mathbf{G}'}
A^{*}_{n\mathbf{k}}(\mathbf{G}') 
\delta_{\mathbf{G}_\parallel \mathbf{G}'_\parallel}f_\ell(\mathbf{G}_\perp-\mathbf{G}'_\perp) 
\sum_{\mathbf{G}''}
A_{m\mathbf{k}}(\mathbf{G}'') 
(\nabla_{\mathbf{K}}+\nabla_{\mathbf{K}''}) 
V^\mathrm{nl}(\mathbf{K},\mathbf{K}'') 
,
\end{align}
where
\begin{align}\label{vnl.8}
\frac{1}{\Omega}
\int d\mathbf{r}\, 
C^{\ell}(z) 
e^{i(\mathbf{G}-\mathbf{G}')\cdot\mathbf{r}}
=\delta_{\mathbf{G}_\parallel \mathbf{G}'_\parallel}f_\ell(\mathbf{G}_\perp-\mathbf{G}'_\perp)
,
\end{align} 
and
\begin{align}\label{vnl.9}
f_\ell(g)=\frac{1}{L}\int_{z_\ell-\Delta^b_\ell}^{z_\ell+\Delta^f_\ell} e^{igz}dz  
 ,
\end{align}
where $f^{*}(g)=f(-g)$.
We define
\begin{align}\label{vnl.10}
\mathcal{F}^{\ell}_{n\mathbf{k}}(\mathbf{G}) 
=
\sum_{\mathbf{G}'}
A_{n\mathbf{k}}(\mathbf{G}') 
\delta_{\mathbf{G}_\parallel \mathbf{G}'_\parallel}f_\ell(\mathbf{G}'_\perp-\mathbf{G}_\perp) 
,
\end{align}
and
\begin{align}\label{vnl.11}
\mathcal{H}_{n\mathbf{k}}(\mathbf{G})&=
\sum_{\mathbf{G}'}
A_{n\mathbf{k}}(\mathbf{G}') 
(\nabla_{\mathbf{K}}+\nabla_{\mathbf{K}'}) 
V^\mathrm{nl}(\mathbf{K},\mathbf{K}') 
,
\end{align}
thus we can compactly write,
\begin{align}\label{vn.12}
\langle n\mathbf{k}\vert C^{\ell}(z) 
\mathbf{v}^\mathrm{nl}\vert m\mathbf{k}\rangle
&=
\frac{1}{\hbar}
\sum_{\mathbf{G}}
\mathcal{F}^{\ell*}_{n\mathbf{k}}(\mathbf{G}) 
\mathcal{H}_{m\mathbf{k}}(\mathbf{G}) 
.
\end{align}
Now, the second term of Eq. \eqref{vnl.5}
\begin{align}\label{vnl.12}
\langle n\mathbf{k}\vert 
\mathbf{v}^\mathrm{nl}
C^{\ell}(z) \vert m\mathbf{k}\rangle
&=\sum_{\mathbf{G}}
\langle n\mathbf{k}\vert 
\mathbf{v}^\mathrm{nl} 
\vert\mathbf{k}+\mathbf{G}\rangle
\langle\mathbf{k}+\mathbf{G}\vert C^{\ell}(z)
\vert m\mathbf{k}\rangle
\nonumber\\
&=\sum_{\mathbf{G}}
\int d\mathbf{r}'' 
\int d\mathbf{r}''' 
\langle n\mathbf{k}\vert 
\vert\mathbf{r}''\rangle\langle\mathbf{r}''\vert 
\mathbf{v}^\mathrm{nl} 
\vert\mathbf{r}'''\rangle\langle\mathbf{r}'''\vert
\vert\mathbf{k}+\mathbf{G}\rangle
\nonumber\\
&\times 
\int d\mathbf{r} 
\int d\mathbf{r}' 
\langle\mathbf{k}+\mathbf{G}\vert
\vert\mathbf{r}\rangle\langle\mathbf{r}\vert  
C^{\ell}(z) 
\vert\mathbf{r}'\rangle\langle\mathbf{r}'\vert
\vert m\mathbf{k}\rangle
\nonumber\\
&=\sum_{\mathbf{G}}
\frac{i}{\hbar}
\int d\mathbf{r}'' 
\int d\mathbf{r}''' 
\langle n\mathbf{k}\vert\mathbf{r}''\rangle
V^\mathrm{nl}(\mathbf{r}'',\mathbf{r}''')(\mathbf{r}'''-\mathbf{r}'') 
\langle\mathbf{r}'''\vert\mathbf{k}+\mathbf{G}\rangle
\nonumber\\
&\times 
\int d\mathbf{r} 
\langle\mathbf{k}+\mathbf{G}\vert\mathbf{r}\rangle
C^{\ell}(z) 
\langle\mathbf{r}\vert m\mathbf{k}\rangle
\nonumber\\
&=\sum_{\mathbf{G}}
\sum_{\mathbf{G}'}
A^{*}_{n\mathbf{k}}(\mathbf{G}') 
\frac{i}{\hbar\Omega}
\int d\mathbf{r}'' 
\int d\mathbf{r}''' 
e^{-i(\mathbf{k}+\mathbf{G}')\cdot\mathbf{r}''} 
V^\mathrm{nl}(\mathbf{r}'',\mathbf{r}''')(\mathbf{r}'''-\mathbf{r}'') 
e^{i(\mathbf{k}+\mathbf{G})\cdot\mathbf{r}'''}
\nonumber\\
&\times 
\sum_{\mathbf{G}''}
A_{m\mathbf{k}}(\mathbf{G}'') 
\frac{1}{\Omega}
\int d\mathbf{r} 
e^{-i(\mathbf{k}+\mathbf{G})\cdot\mathbf{r}} 
C^{\ell}(z) 
e^{i(\mathbf{k}+\mathbf{G}'')\cdot\mathbf{r}}
\nonumber\\
&=
\frac{1}{\hbar}
\sum_{\mathbf{G}}
\sum_{\mathbf{G}'}
A^{*}_{n\mathbf{k}}(\mathbf{G}') 
(\nabla_\mathbf{K}+\nabla_{\mathbf{K}'})
V^\mathrm{nl}(\mathbf{K}',\mathbf{K})
\nonumber\\
&\times 
\sum_{\mathbf{G}''}
A_{m\mathbf{k}}(\mathbf{G}'') 
\delta_{\mathbf{G}_\parallel \mathbf{G}''_\parallel}f_\ell(\mathbf{G}''_\perp-\mathbf{G}_\perp)
\nonumber\\
&=
\frac{1}{\hbar}
\sum_{\mathbf{G}}
\mathcal{H}^{*}_{n\mathbf{k}}(\mathbf{G}) 
\mathcal{F}^{\ell}_{m\mathbf{k}}(\mathbf{G}) 
.
\end{align}
Therefore Eq. \eqref{vnl.5} is compactly given by
\begin{align}\label{vnl.13}
\boldsymbol{\mathcal{V}}^{\mathrm{nl},\ell}_{nm}(\mathbf{k})=\frac{1}{2 \hbar}
\sum_{\mathbf{G}}
\left(
\mathcal{F}^{\ell*}_{n\mathbf{k}}(\mathbf{G}) 
\mathcal{H}_{m\mathbf{k}}(\mathbf{G}) 
+
\mathcal{H}^{*}_{n\mathbf{k}}(\mathbf{G}) 
\mathcal{F}^{\ell}_{m\mathbf{k}}(\mathbf{G}) 
\right)
.
\end{align} 
For fully  separable pseudopotentials in the Kleinman-Bylander (KB) form
\cite{mottaCMS10,kleinmanPRL82,adolphPRB96}, we can use Eq. \eqref{ji.1n} and
evaluate above expression, that we have implemented in the DP code
\cite{olevanoDP}. Explicitly,
\begin{align}\label{vnl.14}
\boldsymbol{\mathcal{V}}^{\mathrm{nl},\ell}_{nm}(\mathbf{k})=\frac{1}{2 \hbar}
\sum_s\sum_{l=0}^{l_s}\sum_{m=-l}^{l}E_l \nonumber\\
\Bigg[ \Bigg(\sum_{{\mathbf{G}''}}
\nabla_{{\mathbf{G}''}}f_{lm}^s({\mathbf{G}''})
\sum_{\mathbf{G}}A^{*}_{n{\mathbf{k}}}(\mathbf{G})\delta_{\mathbf{G}_{||}{\mathbf{G}''}_{||}}
f_\ell(G_z-G''_z) \Bigg)  
\Bigg( \sum_{{\mathbf{G}'}}A_{m{\mathbf{k}}}({\mathbf{G}'})f_{lm}^{s*}({\mathbf{K}'}) \Bigg) \nonumber\\
%
+ \Bigg(\sum_{{\mathbf{G}''}}
f_{lm}^s({\mathbf{G}''})\sum_{\mathbf{G}}A^{*}_{n{\mathbf{k}}}(\mathbf{G})\delta_{\mathbf{G}_{||}{\mathbf{G}''}_{||}}
f_\ell(G_z-G''_z) \Bigg)  
\Bigg( \sum_{{\mathbf{G}'}}A_{m{\mathbf{k}}}({\mathbf{G}'})\nabla_{{\mathbf{K}'}}f_{lm}^{s*}({\mathbf{K}'}) \Bigg)  \nonumber\\
+
\Bigg(\sum_{\mathbf{G}}A^{*}_{n{\mathbf{k}}}(\mathbf{G})\nabla_{\mathbf{G}}f_{lm}^s(\mathbf{G})\Bigg)\Bigg(
\sum_{{\mathbf{G}''}}
f_{lm}^{s*}({\mathbf{G}''})\sum_{{\mathbf{G}'}}A_{m{\mathbf{k}}}({\mathbf{G}'})\delta_{{\mathbf{G}'}_{||}{\mathbf{G}''}_{||}}
f_\ell(G''_z-G'_z) \Bigg) \nonumber\\ 
+
\Bigg(\sum_{\mathbf{G}}A^{*}_{n{\mathbf{k}}}(\mathbf{G})f_{lm}^s(\mathbf{G})
\Bigg) \Bigg(
\sum_{{\mathbf{G}''}}\nabla_{{\mathbf{G}''}}f_{lm}^{s*}({\mathbf{G}''})
\sum_{{\mathbf{G}'}}A_{m{\mathbf{k}}}({\mathbf{G}'})\delta_{{\mathbf{G}'}_{||}{\mathbf{G}''}_{||}}
f_\ell(G''_z-G'_z) \Bigg) \Bigg].\nonumber\\ 
\end{align} 
For a full slab calculation, equivalent to a bulk calculation,
$C^{\ell}(z)=1$ and then 
$f_\ell(g) =\delta_{g0}$, and Eq. \eqref{vnl.14}
reduces to 
Eq. \eqref{forg}. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Explicit expressions for
\texorpdfstring{$\mathcal{V}^{a,\ell}_{nm}(\mathbf{k})$ and
$\mathcal{C}^{\ell}_{nm}(\mathbf{k})$}{Vnm and Cnm}}
\label{app:calpcalc}

Expanding the wave function in planewaves, we obtain
\begin{equation}\label{eni.1}
\psi_{n\mathbf{k}}(\mathbf{r})
= \sum_{\mathbf{G}}
A_{n\mathbf{k}}(\mathbf{G})e^{i(\mathbf{k}+\mathbf{G})\cdot\mathbf{r}},
\end{equation}
where $\{\mathbf{G}\}$ are the reciprocal basis vectors satisfying
$e^{\mathbf{R}\cdot\mathbf{G}} = 1$, $\{\mathbf{R}\}$ are the translation
vectors in real space, and $A_{n\mathbf{k}}(\mathbf{G})$ are the expansion
coefficients. Using $m_{e}\mathbf{v} = -i\hbar\boldsymbol{\nabla}$ into Eqs.
\eqref{vcali} and \eqref{nl.3} we obtain \cite{mendozaPRB06},
\begin{equation}\label{eni.2}
\boldsymbol{\mathcal{V}}^{\ell}_{nm}(\mathbf{k})=
\frac{\hbar}{2m_{e}}\sum_{\mathbf{G},\mathbf{G}'}
A^*_{n\mathbf{k}}(\mathbf{G}')A_{m\mathbf{k}}(\mathbf{G})
(2\mathbf{k}+\mathbf{G}+\mathbf{G}')
\delta_{\mathbf{G}_\parallel \mathbf{G}'_\parallel}f_{\ell}(G_\perp-G'_\perp),
\end{equation}   
with
\begin{align}\label{eni.3}
f_{\ell}(g) = \frac{1}{L}
\int_{z_{\ell}-\Delta^{b}_{\ell}}^{z_{\ell}+\Delta^{f}_{\ell}}
e^{igz}\,dz,
\end{align}
where the reciprocal lattice vectors $\mathbf{G}$ are decomposed into components
parallel to the surface $\mathbf{G}_{\parallel}$, and perpendicular to the
surface $G_{\perp}\hat{z}$, so that $\mathbf{G} = \mathbf{G}_{\parallel} +
G_{\perp}\hat{z}$. Likewise we obtain that
\begin{align*}
\mathcal{C}_{nm}(\mathbf{k})
&=  \int\psi^{*}_{n\mathbf{k}}(\mathbf{r})f(z)
    \psi_{m\mathbf{k}}(\mathbf{r})\,d\mathbf{r}\\
&=  \sum_{\mathbf{G},\mathbf{G^{\prime}}}
    A^{*}_{n\mathbf{k}}(\mathbf{G^{\prime}})
    A_{m\mathbf{k}}(\mathbf{G})
   \int f(z)e^{-i(\mathbf{G}-\mathbf{G^{\prime}})\cdot\mathbf{r}}\,d\mathbf{r}\\
&=  \sum_{\mathbf{G},\mathbf{G^{\prime}}}
    A^{*}_{n\mathbf{k}}(\mathbf{G^{\prime}})
    A_{m\mathbf{k}}(\mathbf{G})\,
    \underbrace{
    \int e^{-i(\mathbf{G}_{\parallel}-\mathbf{G}^{\prime}_{\parallel})
    \cdot\mathbf{R}_{\parallel}}\,d\mathbf{R}_{\parallel}
    }_{\delta_{\mathbf{G}_{\parallel}\mathbf{G}^{\prime}_{\parallel}}}
    \,\underbrace{
    \int e^{-i(g-g^{\prime})z}f(z)\,dz
    }_{f_{\ell}(G_{\perp} - G^{\prime}_{\perp})},
\end{align*}
which we can express compactly as,
\begin{align}\label{eni.4}
\mathcal{C}^{\ell}_{nm}(\mathbf{k})=
\sum_{\mathbf{G},\mathbf{G}'} A^*_{n\mathbf{k}}(\mathbf{G}')  A_{m\mathbf{k}}(\mathbf{G})
\delta_{\mathbf{G}_\parallel \mathbf{G}'_\parallel} 
f_{\ell}(G_\perp-G'_\perp)
.
\end{align}  
The double summation over the $\mathbf{G}$ vectors can be efficiently done by
creating a pointer array to identify all the plane-wave coefficients associated
with the same $G_{\parallel}$. We take $z_{\ell}$ at the center of an atom that
belongs to layer $\ell$, so the equations above give the $\ell$-th atomic-layer
contribution to the optical response \cite{mendozaPRB06}.

If $\mathcal{C}^{\ell}(z) = 1$ from Eqs. \eqref{eni.2} and \eqref{eni.4}, we
recover the well known results
\begin{align}\label{eni.21}
v_{nm}(\mathbf{k})
&= \frac{\hbar}{m_{e}}\sum_{\mathbf{G}}
A^*_{n\mathbf{k}}(\mathbf{G})A_{m\mathbf{k}}(\mathbf{G})(\mathbf{k}+\mathbf{G}),
\nonumber\\
\mathcal{C}^{\ell}_{nm} &= \delta_{nm},
\end{align}  
since for this case, $f_{\ell}(g) = \delta_{g0}$.

We remark that $\boldsymbol{\mathcal{V}}^{\ell}_{nm}(\mathbf{k})$ of Eq.
\eqref{eni.2} does not contain the contribution coming from the scissors
operator. As commented in the paragraph after Eq. \eqref{vopii},
$\boldsymbol{\mathcal{V}}^{\Sigma,\ell}_{nm}(\mathbf{k})\ne
(\omega^{\Sigma}_{nm}/\omega_{nm})
\boldsymbol{\mathcal{V}}^{\mathrm{LDA},\ell}_{nm}(\mathbf{k})$ and
$\boldsymbol{\mathcal{V}}^{\Sigma,\ell}_{nn}(\mathbf{k})\ne
\boldsymbol{\mathcal{V}}^{\mathrm{LDA},\ell}_{nn}(\mathbf{k})$, relations that
are correct whether or not the contribution of $\mathbf{v}^\mathrm{nl}$ is taken
into account. We will learn how to correctly implement the scissors correction
in the next section, Sec. \ref{app:calvs}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Time-reversal relations}
The following relations hold for time-reversal symmetry.
\begin{equation*}
A_{n\mathbf{k}}^{*}(\mathbf{G}) = A_{n-\mathbf{k}}(\mathbf{G}),
\end{equation*}
\begin{equation*}
\mathbf{P}_{n\ell }(-\mathbf{k}) 
=   \hbar\sum_{\mathbf{G}}
    A_{n-\mathbf{k}}^{*}(\mathbf{G})
    A_{\ell -\mathbf{k}}(\mathbf{G})(-\mathbf{k}+\mathbf{G}),
\end{equation*}
\begin{equation*}
(\mathbf{G}\rightarrow-\mathbf{G})
=   -\hbar\sum_{\mathbf{G}}
    A_{n\mathbf{k}}(\mathbf{G})
    A_{\ell\mathbf{k}}^{*}(\mathbf{G})(\mathbf{k}+\mathbf{G})
=   -\mathbf{P}_{\ell n}(\mathbf{k}),
\end{equation*}
\begin{align*}
\mathcal{C}_{nm} (L;-\mathbf{k}) 
&=  \sum_{\mathbf{G}_{\parallel},g,g'}
    A_{n-\mathbf{k}}^{*}(\mathbf{G}_{\parallel},g)
    A_{m-\mathbf{k}}(\mathbf{G}_{\parallel},g')
    f_{\ell}(g-g') \\
&=  \sum_{\mathbf{G}_{\parallel},g,g'}
    A_{n\mathbf{k}} (\mathbf{G}_{\parallel},g)
    A_{m\mathbf{k}}^{*} (\mathbf{G}_{\parallel},g')
    f_{\ell}(g-g') \\
&=  \mathcal{C}_{mn}(L;\mathbf{k}).
\end{align*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{
\texorpdfstring{$\mathcal{V}^{\Sigma,\mathrm{a},\ell}_{nm}$}{Vnm} and 
\texorpdfstring{
$\left(\mathcal{V}^{\Sigma,\mathrm{a},\ell}_{nm}\right)_{;k^\mathrm{b}}$}
{(Vnm);kb}}
\label{app:calvs}

From Eq. \eqref{vopii}
\begin{equation}\label{a.1}
\left(\mathcal{V}^{\Sigma,\mathrm{a},\ell}_{nm}\right)_{;k^\mathrm{b}}
= \left(\mathcal{V}^{\mathrm{LDA},\mathrm{a},\ell}_{nm}\right)_{;k^\mathrm{b}}
+ \left(\mathcal{V}^{{\mathcal{S}},\mathrm{a},\ell}_{nm}\right)_{;k^\mathrm{b}}.
\end{equation} 
For the LDA term we have
\begin{equation}\label{a.2}
\mathcal{V}^{\mathrm{LDA},\mathrm{a},\ell}_{nm}
= \frac{1}{2}
\left(v^{\mathrm{LDA},\mathrm{a}}\mathcal{C}^{\ell}
      + \mathcal{C}^{\ell} v^{\mathrm{LDA},\mathrm{a}}\right)_{nm} 
= \frac{1}{2}\sum_{q}
\left(
  v^{\mathrm{LDA},\mathrm{a}}_{nq}\mathcal{C}^{\ell}_{qm}
+ \mathcal{C}^{\ell}_{nq} v^{\mathrm{LDA},\mathrm{a}}_{qm}
\right)
\end{equation}
and
\begin{align}\label{a.2a}
\left(\mathcal{V}^{\mathrm{LDA},\mathrm{a}}_{nm}\right)_{;k^\mathrm{b}}
&= \frac{1}{2}\sum_{q}\left(  
  v^{\mathrm{LDA},\mathrm{a}}_{nq}\mathcal{C}^{\ell}_{qm}
+ \mathcal{C}^{\ell}_{nq}v^{\mathrm{LDA},\mathrm{a}}_{qm}
\right)_{;k^\mathrm{b}}\nonumber\\
&= \frac{1}{2}\sum_{q}\left(
  (v^{\mathrm{LDA},\mathrm{a}}_{nq})_{;k^\mathrm{b}}\mathcal{C}^{\ell}_{qm}
+  v^{\mathrm{LDA},\mathrm{a}}_{nq}(\mathcal{C}^{\ell}_{qm})_{;k^\mathrm{b}}
+ (\mathcal{C}^{\ell}_{nq})_{;k^\mathrm{b}} v^{\mathrm{LDA},\mathrm{a}}_{qm}
+ \mathcal{C}^{\ell}_{nq} (v^{\mathrm{LDA},\mathrm{a}}_{qm})_{;k^\mathrm{b}}
\right),
\end{align}   
where we omit the $\mathbf{k}$ argument in all terms. From Eq. \eqref{vnln.2} we
know that $\mathbf{v}^\mathrm{nl}_{nm}(\mathbf{k})$ can be readily calculated,
and from Sec. \ref{app:calpcalc}, both $v^{a}_{nm}$ and $\mathcal{C}_{nm}^{\ell}$
are also known quantities. Thus, $\mathbf{v}^\mathrm{LDA}_{nm}(\mathbf{k})$ is
known, and in turn $\mathcal{V}^{\mathrm{LDA},\mathrm{a},\ell}_{nm}$ is also
known. For the generalized derivative
$(\mathbf{v}^\mathrm{LDA}_{nm}(\mathbf{k}))_{;\mathbf{k}}$ we use Eq.
\eqref{chon.98} to write
\begin{align}\label{a.3}
(v^{\mathrm{LDA},\mathrm{a}}_{nm})_{;k^\mathrm{b}}
&= im_{e}(\omega^\mathrm{LDA}_{nm}r^\mathrm{a}_{nm})_{;k^\mathrm{b}}\nonumber\\
&= im_{e}(\omega^\mathrm{LDA}_{nm})_{;k^\mathrm{b}} r^\mathrm{a}_{nm}
 + im_{e}\omega^\mathrm{LDA}_{nm}(r^\mathrm{a}_{nm})_{;k^\mathrm{b}}\nonumber\\
&= im_{e}\Delta^b_{nm}r^\mathrm{a}_{nm}
 + im_{e}\omega^\mathrm{LDA}_{nm}(r^\mathrm{a}_{nm})_{;k^\mathrm{b}}
   \quad\mathrm{for}\quad n\ne m,
\end{align} 
where we used Eq \eqref{eli.13} and $(r^\mathrm{a}_{nm})_{;k^\mathrm{b}}$, from
Eq. \eqref{na_rgendevn}.

Likewise for the scissored term,
\begin{equation}\label{a.3b}
\mathcal{V}^{{\mathcal{S}},\mathrm{a},\ell}_{nm}
= \frac{1}{2}\left(
  v^{{\mathcal{S}},\mathrm{a}}\mathcal{C}^{\ell}
+ \mathcal{C}^{\ell} v^{{\mathcal{S}},\mathrm{a}}
\right)_{nm}
= \frac{1}{2}\sum_{q}\left(  
  v^{{\mathcal{S}},\mathrm{a}}_{nq}\mathcal{C}^{\ell}_{qm}
+ \mathcal{C}^{\ell}_{nq}v^{{\mathcal{S}},\mathrm{a}}_{qm}
\right)
\end{equation}
and
\begin{align}\label{a.3c2}
\left(\mathcal{V}^{{\mathcal{S}},\mathrm{a}}_{nm}\right)_{;k^\mathrm{b}}
&=
\frac{1}{2}\sum_{q}\left(  
v^{{\mathcal{S}},\mathrm{a}}_{nq}\mathcal{C}^{\ell}_{qm}+\mathcal{C}^{\ell}_{nq} v^{{\mathcal{S}},\mathrm{a}}_{qm}
\right)_{;k^\mathrm{b}}\nonumber\\
&= \frac{1}{2}\sum_{q}\left(
  (v^{{\mathcal{S}},\mathrm{a}}_{nq})_{;k^\mathrm{b}}\mathcal{C}^{\ell}_{qm}
+ v^{{\mathcal{S}},\mathrm{a}}_{nq}(\mathcal{C}^{\ell}_{qm})_{;k^\mathrm{b}}
+ (\mathcal{C}^{\ell}_{nq})_{;k^\mathrm{b}} v^{{\mathcal{S}},\mathrm{a}}_{qm}
+ \mathcal{C}^{\ell}_{nq} (v^{{\mathcal{S}},\mathrm{a}}_{qm})_{;k^\mathrm{b}}
\right),
\end{align}   
where $v^{{\mathcal{S}},\mathrm{a}}_{nm}(\mathbf{k})$ is given in Eq.
\eqref{chon.2} and $(v^{{\mathcal{S}},\mathrm{a}}_{nm})_{;k^\mathrm{b}}$ is
given in Eq. (A6) of Ref. \cite{cabellosPRB09} as
\begin{align}\label{choni.1}
(v^{{\mathcal{S}},\mathrm{a}}_{nm})_{;k^\mathrm{b}} = 
i\Delta f_{mn}(r^\mathrm{a}_{nm})_{;k^\mathrm{b}}.
\end{align}

To evaluate $(\mathcal{C}^{\ell}_{nm})_{;k^\mathrm{a}}$, we use the fact that as
$\mathcal{C}^{\ell}(z)$ is only a function of the $z$ coordinate, its commutator
with $\mathbf{r}$ is zero. Then,
\begin{align}\label{a.4}
\langle n\mathbf{k}\vert
\left[r^\mathrm{a},\mathcal{C}^{\ell}(z)\right]
\vert m\mathbf{k}'\rangle
&= \langle n\mathbf{k}\vert
\left[r_{e}^\mathrm{a},\mathcal{C}^{\ell}(z)\right]
\vert m\mathbf{k}'\rangle
+ \langle n\mathbf{k}\vert
\left[r_{i}^\mathrm{a},\mathcal{C}^{\ell}(z)\right]
\vert m\mathbf{k}'\rangle = 0.
\end{align} 
The interband part reduces to,
\begin{align}\label{a.5}
\left[r_{e}^\mathrm{a},\mathcal{C}^{\ell}(z)\right]_{nm}
&= \sum_{q\mathbf{k}''}
\left(
  \langle n\mathbf{k}\vert r_{e}^\mathrm{a}\vert q\mathbf{k}''\rangle
  \langle q\mathbf{k}''\vert\mathcal{C}^{\ell}(z)\vert m\mathbf{k}'\rangle
- \langle n\mathbf{k}\vert\mathcal{C}^{\ell}(z)\vert q\mathbf{k}''\rangle
  \langle q\mathbf{k}''\vert r_{e}^\mathrm{a}\vert m\mathbf{k}'\rangle
\right)\nonumber\\
&= \sum_{q\mathbf{k}''}
\delta(\mathbf{k}-\mathbf{k}'')
\delta(\mathbf{k}'-\mathbf{k}'')
\left(
  (1-\delta_{qn})\xi_{nq}^\mathrm{a}\mathcal{C}^{\ell}_{qm}
- (1-\delta_{qm})\mathcal{C}^{\ell}_{nq}\xi_{qm}^\mathrm{a}
\right)\nonumber\\
&= \delta(\mathbf{k}-\mathbf{k}')
\left(
\sum_{q}
\left(
  \xi_{nq}^\mathrm{a}\mathcal{C}^{\ell}_{qm}
- \mathcal{C}^{\ell}_{nq}\xi_{qm}^\mathrm{a}
\right)
+ \mathcal{C}^{\ell}_{nm}(\xi_{mm}^\mathrm{a}-\xi_{nn}^\mathrm{a})
\right),
\end{align}
where we used Eq. \eqref{rnme}, and the $\mathbf{k}$ and $z$ dependence is
implicitly understood. From Eq. \eqref{conmri3} the intraband part is,
\begin{equation}\label{a.6}
\langle n\mathbf{k}\vert
\left[\hat{\mathbf{r}}_{i},\mathcal{C}^{\ell}(z)\right]
\vert m\mathbf{k}'\rangle
= i\delta(\mathbf{k}-\mathbf{k}')(\mathcal{C}^{\ell}_{nm})_{;\mathbf{k}},
\end{equation}
then from Eq. \eqref{a.4}
\begin{equation}
\left(
(\mathcal{C}^{\ell}_{nm})_{;\mathbf{k}} - i\sum_{q}
\left(\xi_{nq}^\mathrm{a}\mathcal{C}^{\ell}_{qm}
     - \mathcal{C}^{\ell}_{nq}\xi_{qm}^\mathrm{a}\right)
- i\mathcal{C}^{\ell}_{nm}(\xi_{mm}^\mathrm{a}-\xi_{nn}^\mathrm{a})
\right)
i\delta(\mathbf{k}-\mathbf{k}')
= 0,
\end{equation}
which we can simplify,
\begin{align}\label{a.7}
\left(\mathcal{C}^{\ell}_{nm}\right)_{;\mathbf{k}}
&=
i\sum_{q}
\left(
  \xi_{nq}^\mathrm{a}\mathcal{C}^{\ell}_{qm}
- \mathcal{C}^{\ell}_{nq}\xi_{qm}^\mathrm{a}
\right)
+ i\mathcal{C}^{\ell}_{nm}(\xi_{mm}^\mathrm{a}-\xi_{nn}^\mathrm{a})\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&= i\sum_{q\ne nm}
\left(
  \xi_{nq}^\mathrm{a}\mathcal{C}^{\ell}_{qm}
- \mathcal{C}^{\ell}_{nq}\xi_{qm}^\mathrm{a}
\right)
+ i\left(
  \xi_{nn}^\mathrm{a}\mathcal{C}^{\ell}_{nm}
- \mathcal{C}^{\ell}_{nn}\xi_{nm}^\mathrm{a}
\right)_{q=n}
+ i\left(
  \xi_{nm}^\mathrm{a}\mathcal{C}^{\ell}_{mm}
- \mathcal{C}^{\ell}_{nm}\xi_{mm}^\mathrm{a}
\right)_{q=m}
+ i\mathcal{C}^{\ell}_{nm}(\xi_{mm}^\mathrm{a}-\xi_{nn}^\mathrm{a})\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&= i\sum_{q\ne nm}\left(
  \xi_{nq}^\mathrm{a}\mathcal{C}^{\ell}_{qm}
- \mathcal{C}^{\ell}_{nq}\xi_{qm}^\mathrm{a}
\right)
+ i\xi_{nm}^\mathrm{a}(\mathcal{C}^{\ell}_{mm}-\mathcal{C}^{\ell}_{nn})
\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&= i\sum_{q\ne nm}
\left(
  r_{nq}^\mathrm{a}\mathcal{C}^{\ell}_{qm}
- \mathcal{C}^{\ell}_{nq}r_{qm}^\mathrm{a} 
\right) 
+ ir_{nm}^\mathrm{a}(\mathcal{C}^{\ell}_{mm}-\mathcal{C}^{\ell}_{nn})\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&= i\left(
  \sum_{q\ne n}r_{nq}^\mathrm{a}\mathcal{C}^{\ell}_{qm}
- \sum_{q\ne m}\mathcal{C}^{\ell}_{nq}r_{qm}^\mathrm{a}
\right) 
+ ir_{nm}^\mathrm{a}(\mathcal{C}^{\ell}_{mm}-\mathcal{C}^{\ell}_{nn}),
\end{align} 
since in $\xi_{nm}^\mathrm{a}$ we have that $n\ne m$, and we can replace it with
$r^\mathrm{a}_{nm}$. The matrix elements $\mathcal{C}^{\ell}_{nm}(\mathbf{k})$
are calculated in Sec. \ref{app:calpcalc}.

For the general case of
\begin{equation}\label{a.8}
\langle n\mathbf{k}\vert
\left[\hat{r}^\mathrm{a},\hat{\mathcal{G}}(\mathbf{r},\mathbf{p})\right]
\vert m\mathbf{k}'\rangle
= \mathcal{U}_{nm}(\mathbf{k}),
\end{equation}
we can generalize our result to a more general expression, 
\begin{equation}\label{a.9}
({\mathcal{G}}_{nm}(\mathbf{k}))_{;k^\mathrm{a}}
= \mathcal{U}_{nm}(\mathbf{k})
+ i\sum_{q\ne(nm)}
\left(
  r_{nq}^\mathrm{a} (\mathbf{k}){\mathcal{G}}_{qm}(\mathbf{k})
- {\mathcal{G}}_{nq}(\mathbf{k})r_{qm}^\mathrm{a} (\mathbf{k})
\right)
+ ir_{nm}^\mathrm{a}(\mathbf{k})
({\mathcal{G}}_{mm}(\mathbf{k})-{\mathcal{G}}_{nn}(\mathbf{k})).
\end{equation}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Generalized derivative 
\texorpdfstring{$(\omega_{n}(\mathbf{k}))_{;\mathbf{k}}$}{(wn);k}}
\label{app:gwk}

We obtain the generalized derivative $(\omega_{n}(\mathbf{k}))_{;\mathbf{k}}$.
We start from
\begin{equation}\label{a_conH0}
\langle n\mathbf{k}\vert \hat{H}^{\Sigma}_{0} \vert m\mathbf{k}'\rangle
= \delta_{nm}\delta(\mathbf{k}-\mathbf{k}')\hbar\omega^{\Sigma}_{m}(\mathbf{k}),
\end{equation}
then for $n = m$, Eq. \eqref{gendev} yields
\begin{align}\label{a_genderH0}
(H^{\Sigma}_{0,nn})_{;\mathbf{k}}
&= \nabla_{\mathbf{k}}H^{\Sigma}_{0,nn}(\mathbf{k})
 - iH^{\Sigma}_{0,nn}(\mathbf{k})
\left(\boldsymbol{\xi}_{nn}(\mathbf{k})
     -\boldsymbol{\xi}_{nn}(\mathbf{k})\right)\nonumber\\
&= \hbar\nabla_{\mathbf{k}}\omega^{\Sigma}_{m}(\mathbf{k}),
\end{align}
and from Eq. \eqref{conmri3}, 
\begin{equation}\label{a_rih0}
\langle n\mathbf{k}\vert
\left[\hat{\mathbf{r}}_i,\hat{H}_{0}\right]
\vert m\mathbf{k}\rangle
= i\delta_{nm}\hbar(\omega^{\Sigma}_{m}(\mathbf{k}))_{;\mathbf{k}}
= i\delta_{nm}\hbar\nabla_{\mathbf{k}}\omega^{\Sigma}_{m}(\mathbf{k}),
\end{equation}
so
\begin{equation}\label{a_wgendev}
\left(\omega^{\Sigma}_{n}(\mathbf{k})\right)_{;\mathbf{k}}
= \nabla_{\mathbf{k}}\omega^{\Sigma}_{n}(\mathbf{k}).
\end{equation}
From Eq. \eqref{vop},
\begin{equation}\label{a_hr}
\langle n\mathbf{k}\vert
\left[\hat{\mathbf{r}},\hat{H}^{\Sigma}_{0}\right]
\vert m\mathbf{k}\rangle
= i\hbar\mathbf{v}^{\Sigma}_{nm}(\mathbf{k}),
\end{equation}
and substituting Eqs. \eqref{a_rih0} and \eqref{a_hr} into
\begin{equation}\label{a_hrt}
\langle n\mathbf{k}\vert
\left[\hat{\mathbf{r}},\hat{H}^{\Sigma}_{0}\right]
\vert m\mathbf{k}\rangle 
= \langle n\mathbf{k}\vert
  \left[\hat{\mathbf{r}}_i,\hat{H}^{\Sigma}_{0}\right]
  \vert m\mathbf{k}\rangle
+ \langle n\mathbf{k}\vert
  \left[\hat{\mathbf{r}}_e,\hat{H}^{\Sigma}_{0}\right]
  \vert m\mathbf{k}\rangle,
\end{equation}
we get
\begin{equation}\label{a_hrt2}
i\hbar\mathbf{v}^{\Sigma}_{nm}(\mathbf{k})
= i\delta_{nm}\hbar\nabla_{\mathbf{k}}\omega^{\Sigma}_{m}(\mathbf{k})
  + \omega^{\Sigma}_{mn}\mathbf{r}_{e,nm}(\mathbf{k}).
\end{equation}
For $m = n$, we have that
\begin{align}\label{a_gradw}
\nabla_{\mathbf{k}}\omega^{\Sigma}_{n}(\mathbf{k})
    &= \mathbf{v}^{\Sigma}_{nn}(\mathbf{k})\nonumber\\
\nabla_{\mathbf{k}}(\omega{^\mathrm{LDA}}_{n}(\mathbf{k})
    + \frac{\Sigma}{\hbar}(1-f_{n}))
&= \nabla_{\mathbf{k}}\omega{^\mathrm{LDA}}_{n}(\mathbf{k})\nonumber\\
\nabla_{\mathbf{k}}\omega{^\mathrm{LDA}}_{n}(\mathbf{k})
    &= \mathbf{v}^{\Sigma}_{nn}(\mathbf{k}),
\end{align}
where we use Eq. \eqref{chon.78}. However, from Eq. \eqref{chon.2},
$v^{\mathcal{S}}_{nn} = 0$ so $\mathbf{v}^{\Sigma}_{nn}=v{^\mathrm{LDA}}_{nn}$.
Thus, from Eq. \eqref{a_wgendev}
\begin{align}\label{a_gradw2}
(\omega^{\Sigma}_{n}(\mathbf{k}))_{;k^{\mathrm{a}}}
= (\omega{^\mathrm{LDA}}_{n}(\mathbf{k}))_{;k^{\mathrm{a}}}
= v^{\mathrm{LDA},\mathrm{a}}_{nn}(\mathbf{k}),
\end{align}
which is the same for the LDA and scissored Hamiltonians;
$\mathbf{v}_{nn}{^\mathrm{LDA}}(\mathbf{k})$ are the LDA velocities of the
electron in state $\vert n\mathbf{k}\rangle$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Expressions for 
\texorpdfstring{$\chi_{\mathrm{surface}}^{\mathrm{abc}}$}{Xabc} in terms of
\texorpdfstring{$\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}$}{Vmn}}
\label{appv}

The prefactor of Eqs. \eqref{chii} and \eqref{chie} diverges as $\tilde\omega\to
0$. To remove this apparent divergence of $\boldsymbol{\chi}$, we perform a
partial fraction expansion in $\tilde\omega$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Intraband Contributions}

For the intraband term of Eq. \eqref{chii}, we obtain
\begin{align}\label{pfinn} 
I&= 
C
\left[
-\frac{1}{2(\omega^\Sigma_{nm})^2}\frac{1}{\omega^\Sigma_{nm}-\tilde\omega}
+\frac{2}{(\omega^\Sigma_{nm})^2}\frac{1}{\omega^\Sigma_{nm}-2\tilde\omega}
+\frac{1}{2(\omega^\Sigma_{nm})^2}\frac{1}{\tilde\omega}
\right]
\nonumber\\
&-D
\left[
-\frac{3}{2(\omega^\Sigma_{nm})^3}\frac{1}{\omega^\Sigma_{nm}-\tilde\omega}
+\frac{4}{(\omega^\Sigma_{nm})^3}\frac{1}{\omega^\Sigma_{nm}-2\tilde\omega}
+\frac{1}{2(\omega^\Sigma_{nm})^3}\frac{1}{\tilde\omega}
-\frac{1}{2(\omega^\Sigma_{nm})^2}\frac{1}{(\omega^\Sigma_{nm}-\tilde\omega)^2}
\right],
\end{align} 
where $C = f_{mn}\mathcal{V}^{\Sigma,\mathrm{a}}_{mn}
(r^{\mathrm{LDA},\mathrm{b}}_{nm})_{;k^{\mathrm{c}}}$, and $D =
f_{mn}\mathcal{V}^{\Sigma,\mathrm{a}}_{mn}
r^{\mathrm{b}}_{nm}\Delta^{\mathrm{c}}_{nm}$.

Time-reversal symmetry leads to the following relationships:
\begin{equation}\label{time_reversal}
\begin{split}
   \mathbf{r}_{mn}(\mathbf{k})\vert_{-\mathbf{k}}
&= \mathbf{r}_{nm}(\mathbf{k})\vert_{\mathbf{k}},\\
   (\mathbf{r}_{mn})_{;\mathbf{k}}(\mathbf{k})\vert_{-\mathbf{k}}
&= (-\mathbf{r}_{nm})_{;\mathbf{k}}(\mathbf{k})\vert_{\mathbf{k}},\\
   \mathcal{V}^{\Sigma,\text{a},\ell}_{mn}(\mathbf{k})\vert_{-\mathbf{k}}
&= -\mathbf{\mathcal{V}}_{nm}^{\Sigma,\text{a},\ell}(\mathbf{k})
   \vert_{\mathbf{k}},\\
   (\mathcal{V}^{\Sigma,\text{a},\ell}_{mn})_{;\mathbf{k}}
   (\mathbf{k})\vert_{-\mathbf{k}}
&= (\mathbf{\mathcal{V}}_{nm}^{\Sigma,\text{a},\ell})_{;\mathbf{k}}
   (\mathbf{k})\vert_{\mathbf{k}},\\
   \omega_{mn}^{\Sigma}(\mathbf{k})\vert_{-\mathbf{k}}
&= \omega_{mn}^{\Sigma}(\mathbf{k})\vert_{\mathbf{k}},\\
   \Delta^{a}_{nm}(\mathbf{k})\vert_{-\mathbf{k}}
&= -\Delta^{a}_{nm}(\mathbf{k})\vert_{\mathbf{k}}.
\end{split}
\end{equation}
For a clean, cold semiconductor, $f_{n} = 1$ for an occupied or valence $(n =
v)$ band, and $f_{n} = 0$ for an empty or conduction $(n = c)$ band independent
of $\mathbf{k}$, and $f_{nm} = -f_{mn}$. Using the relationships above, we can
show that the $1/\omega$ terms cancel each other out. Therefore, all the
remaining nonzero terms in expressions \eqref{pfinn} are simple $\omega$ and
$2\omega$ resonant denominators that are well behaved at $\omega = 0$.

To apply time-reversal invariance, we notice that the energy denominators are
invariant under $\mathbf{k}\rightarrow -\mathbf{k}$, so we only need to review
the numerators. So,
\begin{align}\label{ct}
C \rightarrow f_{mn}\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\vert_{\mathbf{k}}
&+  f_{mn}\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\vert_{-\mathbf{k}}
    \nonumber\\
&=  f_{mn}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\vert_{\mathbf{k}} 
+   \left(-\mathcal{V}^{\Sigma,\text{a},\ell}_{nm}\right)
    \left(-r^{\text{LDA,b}}_{mn}\right)_{;k^{\text{c}}}\vert_{\mathbf{k}}\right]
    \nonumber\\
&= f_{mn}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}
+   \mathcal{V}^{\Sigma,\text{a},\ell}_{nm}
    \left(r^{\text{LDA,b}}_{mn}\right)_{;k^{\text{c}}}\right]\nonumber\\
&= f_{mn}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn} 
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}
+   \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right)^{*}\right]
    \nonumber\\
&=  2f_{mn}\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right],
\end{align}
and likewise,
\begin{align}\label{dt}
D \rightarrow f_{mn}\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}\Delta^{\text{c}}_{nm}\vert_{\mathbf{k}} 
&+  f_{mn}\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}r^{\text{LDA,b}}_{nm}
    \Delta^{\text{c}}_{nm}\vert_{-\mathbf{k}}\nonumber\\
&=  f_{mn}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}r^{\text{LDA,b}}_{nm}
    \Delta^{\text{c}}_{nm}\vert_{\mathbf{k}}
+   \left(-\mathcal{V}^{\Sigma,\text{a},\ell}_{nm}\right)r^{\text{LDA,b}}_{mn}
    \left(-\Delta^{\text{c}}_{nm}\right)\vert_{\mathbf{k}}\right]\nonumber\\
&=  f_{mn}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}r^{\text{LDA,b}}_{nm}
+   \mathcal{V}^{\Sigma,\text{a},\ell}_{nm}r^{\text{LDA,b}}_{mn}\right]
    \Delta^{\text{c}}_{nm}\nonumber\\
&=  f_{mn}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}r^{\text{LDA,b}}_{nm}
+   \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}\right)^{*}\right]\Delta^{\text{c}}_{nm}\nonumber\\
&=  2f_{mn}\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}\right]\Delta^{\text{c}}_{nm}.
\end{align}

The last term in the second line of Eq. \eqref{pfinn} is dealt with as follows,
\begin{align}\label{dresn}
\frac{D}{2(\omega^\Sigma_{nm})^2}\frac{1}{(\omega^\Sigma_{nm}-\tilde\omega)^2}
&= \frac{f_{mn}}{2}
   \frac{\mathcal{V}^{\Sigma,\mathrm{a}}_{mn}r^{\mathrm{b}}_{nm}}
        {(\omega^\Sigma_{nm})^2}
   \frac{\Delta^{\mathrm{c}}_{nm}}{(\omega^\Sigma_{nm}-\tilde\omega)^2} 
= -\frac{f_{mn}}{2}
   \frac{\mathcal{V}^{\Sigma,\mathrm{a}}_{mn}r^{\mathrm{b}}_{nm}}
        {(\omega^\Sigma_{nm})^2}
\left(
\frac{1}{\omega^\Sigma_{nm}-\tilde\omega}
\right)_{;k^{\mathrm{c}}}\nonumber\\
&= \frac{f_{mn}}{2}
\left(
\frac{\mathcal{V}^{\Sigma,\mathrm{a}}_{mn}r^{\mathrm{b}}_{nm}}
     {(\omega^\Sigma_{nm})^2}
\right)_{;k^{\mathrm{c}}}
\frac{1}{\omega^\Sigma_{nm}-\tilde\omega},
\end{align} 
where we used Eq. \eqref{eli.13}. For the last line, we performed an integration
by parts over the Brillouin zone where the contribution from the edges vanishes
\cite{ashcroftbook}. Now, we apply the chain rule, to get
\begin{equation}\label{chr}
    \left(\frac{\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}r^{\text{LDA,b}}_{nm}}
    {(\omega^{\Sigma}_{nm})^2}\right)_{;k^{\text{c}}}
=   \frac{r^{\text{LDA,b}}_{nm}}{(\omega^{\Sigma}_{nm})^2}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}\right)_{;k^{\text{c}}}
+   \frac{\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}}{(\omega^{\Sigma}_{nm})^2}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}
-   \frac{2\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}}{(\omega^{\Sigma}_{nm})^3}
    \left(\omega^{\Sigma}_{nm}\right)_{;k^{\text{c}}},
\end{equation}
and work the time-reversal on each term. The first term is reduced to
\begin{align}\label{first_term_gen_deriv}
    \frac{r^{\text{LDA,b}}_{nm}}{(\omega^{\Sigma}_{nm})^{2}}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}\right)
    _{;k^{\text{c}}}\vert_{\mathbf{k}}
+   \frac{r^{\text{LDA,b}}_{nm}}{(\omega^{\Sigma}_{nm})^{2}}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}\right)
    _{;k^{\text{c}}}\vert_{-\mathbf{k}}
&=  \frac{r^{\text{LDA,b}}_{nm}}{(\omega^{\Sigma}_{nm})^{2}}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}\right)
    _{;k^{\text{c}}}\vert_{\mathbf{k}}
+   \frac{r^{\text{LDA,b}}_{mn}}{(\omega^{\Sigma}_{nm})^{2}}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{nm}\right)
    _{;k^{\text{c}}}\vert_{\mathbf{k}}\nonumber\\
&=  \frac{1}{(\omega^{\Sigma}_{nm})^{2}}\left[r^{\text{LDA,b}}_{nm}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}\right)
    _{;k^{\text{c}}}
+   \left(r^{\text{LDA,b}}_{nm}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}\right)
    _{;k^{\text{c}}}\right)^{*}\right]\nonumber\\
&=  \frac{2}{(\omega^{\Sigma}_{nm})^{2}}\mathrm{Re}\left[r^{\text{LDA,b}}_{nm}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}\right)_{;k^{\text{c}}}\right],
\end{align}
the second term is reduced to
\begin{align}\label{second_term_gen_deriv}
    \frac{\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}}{(\omega^{\Sigma}_{nm})^{2}}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\vert_{\mathbf{k}}
+   \frac{\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}}{(\omega^{\Sigma}_{nm})^{2}}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\vert_{-\mathbf{k}}
&=  \frac{\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}}{(\omega^{\Sigma}_{nm})^{2}}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\vert_{\mathbf{k}}
+   \frac{\mathcal{V}^{\Sigma,\text{a},\ell}_{nm}}{(\omega^{\Sigma}_{nm})^{2}}
    \left(r^{\text{LDA,b}}_{mn}\right)_{;k^{\text{c}}}\vert_{\mathbf{k}}
    \nonumber\\
&=  \frac{1}{(\omega^{\Sigma}_{nm})^{2}}
    \left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}
+   \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right)^{*}\right]
    \nonumber\\
&=  \frac{2}{(\omega^{\Sigma}_{nm})^{2}}\mathrm{Re}
    \left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right],
\end{align}
and by using \eqref{eli.13}, the third term is reduced to
\begin{align}\label{third_term_gen_deriv}
    \frac{2\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}}{(\omega^{\Sigma}_{nm})^{3}}
    \left(\omega^{\Sigma}_{nm}\right)_{;k^{\text{c}}}\vert_{\mathbf{k}}
+   \frac{2\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}}{(\omega^{\Sigma}_{nm})^{3}}
    \left(\omega^{\Sigma}_{nm}\right)_{;k^{\text{c}}}\vert_{-\mathbf{k}}
&=  \frac{2\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}}{(\omega^{\Sigma}_{nm})^{3}}
    \Delta_{nm}^{\text{c}}\vert_{\mathbf{k}}
+   \frac{2\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}}{(\omega^{\Sigma}_{nm})^{3}}
    \Delta_{nm}^{\text{c}}\vert_{-\mathbf{k}}\nonumber\\
&=  \frac{2\mathcal{V}^{\Sigma,\text{a},\ell}_{nm}
    r^{\text{LDA,b}}_{mn}}{(\omega^{\Sigma}_{nm})^{3}}
    \Delta_{nm}^{\text{c}}\vert_{\mathbf{k}}
+   \frac{2\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}}{(\omega^{\Sigma}_{nm})^{3}}
    \Delta_{nm}^{\text{c}}\vert_{\mathbf{k}}\nonumber\\
&=  \frac{2}{(\omega^{\Sigma}_{nm})^{3}}
    \left[\mathcal{V}^{\Sigma,\text{a},\ell}_{nm}r^{\text{LDA,b}}_{mn}
+   \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{nm}
    r^{\text{LDA,b}}_{mn}\right)^{*}\right]\Delta_{nm}^{\text{c}}\nonumber\\
&=  \frac{4}{(\omega^{\Sigma}_{nm})^{3}}\mathrm{Re}
    \left[\mathcal{V}^{\Sigma,\text{a},\ell}_{nm}r^{\text{LDA,b}}_{mn}\right]
    \Delta_{nm}^{\text{c}}.
\end{align}

Combining the results from \eqref{first_term_gen_deriv},
\eqref{second_term_gen_deriv}, and \eqref{third_term_gen_deriv}
into \eqref{chr},
\begin{align}\label{derivative_under_k}
&\frac{f_{mn}}{2}
\left[
\left(
\frac{\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
r^{\text{LDA,b}}_{nm}}{(\omega^\Sigma_{nm})^2}
\right)_{;k^{\text{c}}}\vert_{\mathbf{k}} 
+ \left(
  \frac{\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
  r^{\text{LDA,b}}_{nm}}{(\omega^\Sigma_{nm})^2}
  \right)_{;k^{\text{c}}}\vert_{-\mathbf{k}}
  \right]
  \frac{1}{\omega^\Sigma_{nm}-\tilde\omega}
= \nonumber\\
& \left(
  2\,\mathrm{Re}\left[r^{\text{LDA,b}}_{nm}
  \left(
  \mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
  \right)_{;k^{\text{c}}}
  \right]
+ 2\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
  \left(
  r^{\text{LDA,b}}_{nm}
  \right)_{;k^{\text{c}}}
  \right] 
- \frac{4}{\omega^{\Sigma}_{nm}}\mathrm{Re}
  \left[
  \mathcal{V}^{\Sigma,\text{a},\ell}_{nm}r^{\text{LDA,b}}_{mn}
  \right]
  \Delta_{nm}^{\text{c}}
  \right)
  \frac{f_{mn}}{2(\omega^{\Sigma}_{nm})^{2}}
  \frac{1}{\omega^\Sigma_{nm}-\tilde\omega}.
\end{align}
We substitute \eqref{ct}, \eqref{dt}, and \eqref{derivative_under_k} in 
\eqref{pfinn},
\begin{align*}
I
=   &\left[
    -\frac{2f_{mn}\,\mathrm{Re}
    \left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right]}
    {2(\omega^{\Sigma}_{nm})^{2}}\frac{1}{\omega^{\Sigma}_{nm}-\tilde\omega} 
+   \frac{4f_{mn}\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right]}
    {(\omega^{\Sigma}_{nm})^{2}}\frac{1}{\omega^{\Sigma}_{nm}-2\tilde\omega}
    \right]\nonumber\\
+   &\left[\frac{6f_{mn}\,\mathrm{Re}
    \left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}r^{\text{LDA,b}}_{nm}\right]
    \Delta^{\text{c}}_{nm}}{2(\omega^{\Sigma}_{nm})^{3}}
    \frac{1}{\omega^{\Sigma}_{nm}-\tilde\omega} 
-   \frac{8f_{mn}\,\mathrm{Re}
    \left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}r^{\text{LDA,b}}_{nm}\right]
    \Delta^{\text{c}}_{nm}}{(\omega^{\Sigma}_{nm})^{3}}
    \frac{1}{\omega^{\Sigma}_{nm}-2\tilde\omega}\right.\nonumber\\
&\,\,\,+ 
    \left.\frac{f_{mn}\left(2\,\mathrm{Re}\left[r^{\text{LDA,b}}_{nm}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}\right)_{;k^{\text{c}}}\right]
+   2\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right] 
-   \frac{4}{\omega^{\Sigma}_{nm}}\,\mathrm{Re}
    \left[\mathcal{V}^{\Sigma,\text{a},\ell}_{nm}r^{\text{LDA,b}}_{mn}\right]
    \Delta_{nm}^{\text{c}}\right)}{2(\omega^{\Sigma}_{nm})^{2}}
    \frac{1}{\omega^\Sigma_{nm}-\tilde\omega}\right]
.
\end{align*}
If we simplify,
\begin{align}\label{simplified_i} 
I =
-   \frac{2f_{mn}\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right]}
    {2(\omega^{\Sigma}_{nm})^{2}}&\frac{1}{\omega^{\Sigma}_{nm}-\tilde\omega}
+   \frac{4f_{mn}\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right]}
    {(\omega^{\Sigma}_{nm})^{2}}\frac{1}{\omega^{\Sigma}_{nm}-2\tilde\omega}
    \nonumber\\
+   \frac{6f_{mn}\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}\right]
    \Delta^{\text{c}}_{nm}}{2(\omega^{\Sigma}_{nm})^{3}}
    &\frac{1}{\omega^{\Sigma}_{nm}-\tilde\omega} 
\,- \frac{8f_{mn}\,\mathrm{Re}
    \left[
    \mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}
    \right]
    \Delta^{\text{c}}_{nm}}{(\omega^{\Sigma}_{nm})^{3}}
    \frac{1}{\omega^{\Sigma}_{nm}-2\tilde\omega}\nonumber\\
+   \frac{2f_{mn}\,\mathrm{Re}\left[r^{\text{LDA,b}}_{nm}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}\right)
    _{;k^{\text{c}}}\right]}{2(\omega^{\Sigma}_{nm})^{2}}
    &\frac{1}{\omega^{\Sigma}_{nm}-\tilde\omega}\nonumber\\
+   \frac{2f_{mn}\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right]}
    {2(\omega^{\Sigma}_{nm})^{2}}&\frac{1}{\omega^{\Sigma}_{nm}-\tilde\omega}
    \nonumber\\
-   \frac{4f_{mn}\mathrm{Re}
    \left[
    \mathcal{V}^{\Sigma,\text{a},\ell}_{nm}
    r^{\text{LDA,b}}_{mn}
    \right]
    \Delta_{nm}^{\text{c}}}{2(\omega^{\Sigma}_{nm})^{3}}
    &\frac{1}{\omega^{\Sigma}_{nm}-\tilde\omega},
\end{align}
we conveniently collect the terms in columns of $\omega$ and $2\omega$. We can
now express the susceptibility in terms of $\omega$ and $2\omega$. Separating
the $2\omega$ terms and substituting in the equation above,
\begin{align}\label{2wchii}
I_{2\omega}
&=  -\frac{e^{3}}{\hbar^2}\sum_{mn\mathbf{k}}\left[\frac{4f_{mn}\,\mathrm{Re}
    \left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right]}
    {(\omega^{\Sigma}_{nm})^{2}} - \frac{8f_{mn}\,\mathrm{Re}
    \left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}r^{\text{LDA,b}}_{nm}\right]
    \Delta^{\text{c}}_{nm}}{(\omega^{\Sigma}_{nm})^{3}}\right]
    \frac{1}{\omega^{\Sigma}_{nm}-2\tilde\omega}\nonumber\\
&=  -\frac{e^3}{\hbar^2}\sum_{mn\mathbf{k}}
    \frac{4f_{mn}}{(\omega^{\Sigma}_{nm})^{2}}
    \left[
    \mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right] 
-   \frac{2\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}\right]\Delta^{\text{c}}_{nm}}{\omega^{\Sigma}_{nm}}
    \right]
    \frac{1}{\omega^{\Sigma}_{nm}-2\tilde\omega}.
\end{align}

We can express the energies in terms of transitions between bands. Therefore,
$\omega^{\Sigma}_{nm} = \omega^{\Sigma}_{cv}$ for transitions between conduction
and valence bands. To take the limit $\eta\to 0$, we use
\begin{equation}\label{limit_eta}
\lim_{\eta\to 0}\frac{1}{x\pm i\eta} = P\frac{1}{x}\mp i\pi\delta(x),
\end{equation}
and can finally rewrite \eqref{2wchii} in the desired form,
\begin{equation}\label{imchi2w}
    \mathrm{Im}[\chi_{i,\text{a},\ell\text{b}\text{c},2\omega}^{s,\ell}] 
=   -\frac{\pi \vert e\vert^{3}}{2\hbar^2}\sum_{vc\mathbf{k}}
    \frac{4}{(\omega^{\Sigma}_{cv})^{2}}\left(\mathrm{Re}
    \left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}
    \left(r^{\text{LDA,b}}_{cv}\right)_{;k^{\text{c}}}\right] 
-   \frac{2\,\mathrm{Re}
    \left[
    \mathcal{V}^{\Sigma,\text{a},\ell}_{vc}r^{\text{LDA,b}}_{cv}
    \right]
    \Delta^{\text{c}}_{cv}}{\omega^{\Sigma}_{cv}}\right)
    \delta(\omega^{\Sigma}_{cv}-2\omega).
\end{equation}
where we added a $1/2$ from the sum over $\mathbf{k} \rightarrow - \mathbf{k}$.
We do the same for the $\tilde\omega$ terms in \eqref{simplified_i} to obtain
\begin{align}\label{wchii}
I_{\omega}
= -\frac{e^3}{2\hbar^2}\sum_{nm\mathbf{k}}
\Biggl[
-   \frac{2f_{mn}\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right]}
    {(\omega^{\Sigma}_{nm})^{2}}
&+  \frac{6f_{mn}\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}\right]
    \Delta^{\text{c}}_{nm}}{(\omega^{\Sigma}_{nm})^{3}}
    \nonumber\\
+   \frac{2f_{mn}\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    \left(r^{\text{LDA,b}}_{nm}\right)_{;k^{\text{c}}}\right]}
    {(\omega^{\Sigma}_{nm})^{2}}
&-  \frac{4f_{mn}\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{nm}
    r^{\text{LDA,b}}_{mn}\right]
    \Delta_{nm}^{\text{c}}}{(\omega^{\Sigma}_{nm})^{3}}
    \nonumber\\
&+  \frac{2f_{mn}\,\mathrm{Re}\left[r^{\text{LDA,b}}_{nm}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}\right)
    _{;k^{\text{c}}}\right]}{(\omega^{\Sigma}_{nm})^{2}}
\Biggr]\frac{1}{\omega^{\Sigma}_{nm}-\tilde\omega}.
\end{align}
We reduce in the same way as \eqref{2wchii}, 
\begin{equation}\label{wchii_simplified}
I_{\omega}
=   -\frac{e^3}{2\hbar^2}\sum_{nm\mathbf{k}}
    \frac{f_{mn}}{(\omega^{\Sigma}_{nm})^{2}}
\Biggl[
    2\,\mathrm{Re}\left[r^{\text{LDA,b}}_{nm}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}\right)_{;k^{\text{c}}}\right]
+   \frac{2\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{LDA,b}}_{nm}\right]\Delta^{\text{c}}_{nm}}{\omega^{\Sigma}_{nm}} 
\Biggr]\frac{1}{\omega^{\Sigma}_{nm}-\tilde\omega},
\end{equation}
and using \eqref{limit_eta} we obtain our final form,
\begin{equation}
\mathrm{Im}[\chi_{i,\text{a},\ell\text{b}\text{c},\omega}^{s,\ell}]
=   -\frac{\pi\vert e\vert^3}{2\hbar^2}
    \sum_{cv}\frac{1}{(\omega^{\Sigma}_{cv})^{2}}
\left(
    \mathrm{Re}\left[r^{\text{LDA,b}}_{cv}
    \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}\right)_{;k^{\text{c}}}\right]
+   \frac{\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}
    r^{\text{LDA,b}}_{cv}\right]\Delta^{\text{c}}_{cv}}{\omega^{\Sigma}_{cv}} 
\right)\delta(\omega^{\Sigma}_{cv}-\omega)
,
\end{equation}
where again we added a $1/2$ from the sum over $\mathbf{k} \rightarrow -
\mathbf{k}$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Interband Contributions}

We follow an equivalent procedure for the interband contribution. From Eq.
\eqref{chie} we have
\begin{align}\label{ewithaandb}  
E&= A
\left[
-\frac{1}{2\omega^\Sigma_{lm}(2\omega^\Sigma_{lm}-\omega^\Sigma_{nm})}
 \frac{1}{\omega^\Sigma_{lm}-\tilde\omega}
+\frac{2}{\omega^\Sigma_{nm}(2\omega^\Sigma_{lm}-\omega^\Sigma_{nm})}
 \frac{1}{\omega^\Sigma_{nm}-2\tilde\omega}
+\frac{1}{2\omega^\Sigma_{lm}\omega^\Sigma_{nm}}
 \frac{1}{\tilde\omega}
\right]
\nonumber\\
&- B
\left[
-\frac{1}{2\omega^\Sigma_{nl}(2\omega^\Sigma_{nl}-\omega^\Sigma_{nm})}
 \frac{1}{\omega^\Sigma_{nl}-\tilde\omega}
+\frac{2}{\omega^\Sigma_{nm}(2\omega^\Sigma_{nl}-\omega^\Sigma_{nm})}
 \frac{1}{\omega^\Sigma_{nm}-2\tilde\omega}
+\frac{1}{2\omega^\Sigma_{nl}\omega^\Sigma_{nm}}
 \frac{1}{\tilde\omega}
\right],
\end{align}  
where 
$A=f_{ml}\mathcal{V}^{\Sigma,\text{a}}_{mn}r^{\text{c}}_{nl}r^{\text{b}}_{lm}$   
and
$B=f_{ln}\mathcal{V}^{\Sigma,\text{a}}_{mn}r^{\text{b}}_{nl}r^{\text{c}}_{lm}$.

Just as above, the $\frac{1}{\tilde\omega}$ terms cancel out. We multiply out
the $A$ and $B$ terms,
\begin{align}\label{emultipied}  
E&=  
\left[
-\frac{A}{2\omega^\Sigma_{lm}(2\omega^\Sigma_{lm}-\omega^\Sigma_{nm})}
 \frac{1}{\omega^\Sigma_{lm}-\tilde\omega}
+\frac{2A}{\omega^\Sigma_{nm}(2\omega^\Sigma_{lm}-\omega^\Sigma_{nm})}
 \frac{1}{\omega^\Sigma_{nm}-2\tilde\omega}
\right]\nonumber\\
&+ 
\left[
 \frac{B}{2\omega^\Sigma_{nl}(2\omega^\Sigma_{nl}-\omega^\Sigma_{nm})}
 \frac{1}{\omega^\Sigma_{nl}-\tilde\omega}
-\frac{2B}{\omega^\Sigma_{nm}(2\omega^\Sigma_{nl}-\omega^\Sigma_{nm})}
 \frac{1}{\omega^\Sigma_{nm}-2\tilde\omega}
\right].
\end{align}  
As before, we notice that the energy denominators are invariant under
$\mathbf{k} \rightarrow - \mathbf{k}$ so we need only to review the numerators.
Starting with $A$,
\begin{align*}
A \rightarrow f_{ml}\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{c}}_{nl}r^{\text{b}}_{lm}\vert_{\mathbf{k}}
&+  f_{ml}\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}r^{\text{c}}_{nl}
    r^{\text{b}}_{lm}\vert_{-\mathbf{k}}\nonumber\\
&=  f_{ml}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{c}}_{nl}r^{\text{b}}_{lm}\vert_{\mathbf{k}} 
+   \left(-\mathcal{V}^{\Sigma,\text{a},\ell}_{nm}\right)
    r^{\text{c}}_{ln}r^{\text{b}}_{ml}\vert_{\mathbf{k}}\right]\nonumber\\
&=  f_{ml}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{c}}_{nl}r^{\text{b}}_{lm} 
-   \mathcal{V}^{\Sigma,\text{a},\ell}_{nm}
    r^{\text{c}}_{ln}r^{\text{b}}_{ml}\right]\nonumber\\
&=  f_{ml}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{c}}_{nl}r^{\text{b}}_{lm}
-   \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{c}}_{nl}r^{\text{b}}_{lm}\right)^{*}\right]\nonumber\\
&= -2f_{ml}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{c}}_{nl}r^{\text{b}}_{lm}\right],
\end{align*}
then $B$,
\begin{align*}
B \rightarrow f_{ln}\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{b}}_{nl}r^{\text{c}}_{lm}\vert_{\mathbf{k}}
&+  f_{ln}\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}r^{\text{b}}_{nl}
    r^{\text{c}}_{lm}\vert_{-\mathbf{k}}\nonumber\\
&=  f_{ln}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{b}}_{nl}r^{\text{c}}_{lm}\vert_{\mathbf{k}} 
+   \left(-\mathcal{V}^{\Sigma,\text{a},\ell}_{nm}\right)
    r^{\text{b}}_{ln}r^{\text{c}}_{ml}\vert_{\mathbf{k}}\right]\nonumber\\
&=  f_{ln}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{b}}_{nl}r^{\text{c}}_{lm} 
-   \mathcal{V}^{\Sigma,\text{a},\ell}_{nm}
    r^{\text{b}}_{ln}r^{\text{c}}_{ml}\right]\nonumber\\
&=  f_{ln}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{b}}_{nl}r^{\text{c}}_{lm}
-   \left(\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{b}}_{nl}r^{\text{c}}_{lm}\right)^{*}\right]\nonumber\\
&= -2f_{ln}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
    r^{\text{b}}_{nl}r^{\text{c}}_{lm}\right].
\end{align*}
We then substitute in \eqref{emultipied},
\begin{align*}
E =  
\Bigg[
  \frac{2f_{ml}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
        r^{\text{c}}_{nl}
        r^{\text{b}}_{lm}\right]}
        {2\omega^\Sigma_{lm}(2\omega^\Sigma_{lm}-\omega^\Sigma_{nm})}
\frac{1}{\omega^\Sigma_{lm}-\tilde\omega}
&-\frac{4f_{ml}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
        r^{\text{c}}_{nl}
        r^{\text{b}}_{lm}\right]}
        {\omega^\Sigma_{nm}(2\omega^\Sigma_{lm}-\omega^\Sigma_{nm})}
\frac{1}{\omega^\Sigma_{nm}-2\tilde\omega}\nonumber\\
-\frac{2f_{ln}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
        r^{\text{b}}_{nl}
        r^{\text{c}}_{lm}\right]}
        {2\omega^\Sigma_{nl}(2\omega^\Sigma_{nl}-\omega^\Sigma_{nm})}
\frac{1}{\omega^\Sigma_{nl}-\tilde\omega}
&+\frac{4f_{ln}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
        r^{\text{b}}_{nl}
        r^{\text{c}}_{lm}\right]}
        {\omega^\Sigma_{nm}(2\omega^\Sigma_{nl}-\omega^\Sigma_{nm})}
\frac{1}{\omega^\Sigma_{nm}-2\tilde\omega}
\Bigg]
.
\end{align*}
We manipulate indices and simplify,
\begin{align*}
E &=  
\Bigg[
  \frac{f_{ml}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
        r^{\text{c}}_{nl}
        r^{\text{b}}_{lm}\right]}
        {\omega^\Sigma_{lm}(2\omega^\Sigma_{lm}-\omega^\Sigma_{nm})}
\frac{1}{\omega^\Sigma_{lm}-\tilde\omega}
 -\frac{f_{ln}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
        r^{\text{b}}_{nl}
        r^{\text{c}}_{lm}\right]}
        {\omega^\Sigma_{nl}(2\omega^\Sigma_{nl}-\omega^\Sigma_{nm})}
\frac{1}{\omega^\Sigma_{nl}-\tilde\omega}
\Bigg]\nonumber\\
&\qquad+
\Bigg[
  \frac{f_{ln}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
        r^{\text{b}}_{nl}
        r^{\text{c}}_{lm}\right]}
        {2\omega^\Sigma_{nl}-\omega^\Sigma_{nm}}
 -\frac{f_{ml}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
        r^{\text{c}}_{nl}
        r^{\text{b}}_{lm}\right]}
        {2\omega^\Sigma_{lm}-\omega^\Sigma_{nm}}
\Bigg]\frac{4}{\omega^\Sigma_{nm}}\frac{1}{\omega^\Sigma_{nm}-2\tilde\omega}
\nonumber\\
&=  
\Bigg[
  \frac{f_{mn}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{ml}
        r^{\text{c}}_{ln}
        r^{\text{b}}_{nm}\right]}
        {2\omega^\Sigma_{nm}-\omega^\Sigma_{lm}}
 -\frac{f_{mn}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{ln}
        r^{\text{b}}_{nm}
        r^{\text{c}}_{ml}\right]}
        {2\omega^\Sigma_{nm}-\omega^\Sigma_{nl}}
\Bigg]\frac{1}{\omega^\Sigma_{nm}}\frac{1}{\omega^\Sigma_{nm}-\tilde\omega}
\nonumber\\
&\qquad+
\Bigg[
  \frac{f_{ln}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
        r^{\text{b}}_{nl}
        r^{\text{c}}_{lm}\right]}
        {2\omega^\Sigma_{nl}-\omega^\Sigma_{nm}}
 -\frac{f_{ml}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
        r^{\text{c}}_{nl}
        r^{\text{b}}_{lm}\right]}
        {2\omega^\Sigma_{lm}-\omega^\Sigma_{nm}}
\Bigg]\frac{4}{\omega^\Sigma_{nm}}\frac{1}{\omega^\Sigma_{nm}-2\tilde\omega},
\end{align*}
and substitute in \eqref{chie},
\begin{align*}
I = -\frac{e^3}{2\hbar^2}\sum_{nm}\frac{1}{\omega^\Sigma_{nm}}
&\left[
  \frac{f_{mn}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{ml}
        \{r^{\text{c}}_{ln}
        r^{\text{b}}_{nm}\}\right]}
        {2\omega^\Sigma_{nm}-\omega^\Sigma_{lm}}
 -\frac{f_{mn}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{ln}
        \{r^{\text{b}}_{nm}
        r^{\text{c}}_{ml}\}\right]}
        {2\omega^\Sigma_{nm}-\omega^\Sigma_{nl}}
\right]\frac{1}{\omega^\Sigma_{nm}-\tilde\omega}\nonumber\\
+
4&\left[
  \frac{f_{ln}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
        \{r^{\text{b}}_{nl}
        r^{\text{c}}_{lm}\}\right]}
        {2\omega^\Sigma_{nl}-\omega^\Sigma_{nm}}
 -\frac{f_{ml}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{mn}
        \{r^{\text{c}}_{nl}
        r^{\text{b}}_{lm}\}\right]}
        {2\omega^\Sigma_{lm}-\omega^\Sigma_{nm}}
\right]\frac{1}{\omega^\Sigma_{nm}-2\tilde\omega}.
\end{align*}
Finally, we take $n = c$, $m = v$, and $l = q$ and substitute,
\begin{align*}
I &= -\frac{e^3}{2\hbar^2}\sum_{cv}\frac{1}{\omega^\Sigma_{cv}}
  \left(\left[
  \frac{f_{vc}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vq}
        \{r^{\text{c}}_{qc}
        r^{\text{b}}_{cv}\}\right]}
        {2\omega^\Sigma_{cv}-\omega^\Sigma_{qv}}
 -\frac{f_{vc}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{qc}
        \{r^{\text{b}}_{cv}
        r^{\text{c}}_{vq}\}\right]}
        {2\omega^\Sigma_{cv}-\omega^\Sigma_{cq}}
\right]\frac{1}{\omega^\Sigma_{cv}-\tilde\omega}\right.\nonumber\\
&\qquad
+4\left.\left[
  \frac{f_{qc}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}
        \{r^{\text{b}}_{cq}
        r^{\text{c}}_{qv}\}\right]}
        {2\omega^\Sigma_{cq}-\omega^\Sigma_{cv}}
 -\frac{f_{vq}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}
        \{r^{\text{c}}_{cq}
        r^{\text{b}}_{qv}\}\right]}
        {2\omega^\Sigma_{qv}-\omega^\Sigma_{cv}}
\right]\frac{1}{\omega^\Sigma_{cv}-2\tilde\omega}\right)\nonumber\\
&= \frac{e^3}{2\hbar^2}\sum_{cv}\frac{1}{\omega^\Sigma_{cv}}
\left(\left[
 \frac{\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{qc}
        \{r^{\text{b}}_{cv}
        r^{\text{c}}_{vq}\}\right]}
        {2\omega^\Sigma_{cv}-\omega^\Sigma_{cq}}
 -\frac{\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vq}
        \{r^{\text{c}}_{qc}
        r^{\text{b}}_{cv}\}\right]}
        {2\omega^\Sigma_{cv}-\omega^\Sigma_{qv}}
\right]\frac{1}{\omega^\Sigma_{cv}-\tilde\omega}\right.\nonumber\\
&\qquad-4
\left.\left[
  \frac{f_{qc}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}
        \{r^{\text{b}}_{cq}
        r^{\text{c}}_{qv}\}\right]}
        {2\omega^\Sigma_{cq}-\omega^\Sigma_{cv}}
 -\frac{f_{vq}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}
        \{r^{\text{c}}_{cq}
        r^{\text{b}}_{qv}\}\right]}
        {2\omega^\Sigma_{qv}-\omega^\Sigma_{cv}}
\right]\frac{1}{\omega^\Sigma_{cv}-2\tilde\omega}\right).
\end{align*}
We use \eqref{limit_eta},
\begin{align*}
I = \frac{\pi|e^3|}{2\hbar^2}\sum_{cv}\frac{1}{\omega^\Sigma_{cv}}
&\left(\left[
 \frac{\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{qc}
        \{r^{\text{b}}_{cv}
        r^{\text{c}}_{vq}\}\right]}
        {2\omega^\Sigma_{cv}-\omega^\Sigma_{cq}}
 -\frac{\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vq}
        \{r^{\text{c}}_{qc}
        r^{\text{b}}_{cv}\}\right]}
        {2\omega^\Sigma_{cv}-\omega^\Sigma_{qv}}
\right]\delta(\omega^{\Sigma}_{cv}-\omega)\right.\nonumber\\
-
4&\left.\left[
  \frac{f_{qc}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}
        \{r^{\text{b}}_{cq}
        r^{\text{c}}_{qv}\}\right]}
        {2\omega^\Sigma_{cq}-\omega^\Sigma_{cv}}
 -\frac{f_{vq}\,\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}
        \{r^{\text{c}}_{cq}
        r^{\text{b}}_{qv}\}\right]}
        {2\omega^\Sigma_{qv}-\omega^\Sigma_{cv}}
\right]\delta(\omega^{\Sigma}_{cv}-2\omega)\right)
,
\end{align*}
and recognize that for the $1\omega$ terms, $q\neq (v,c)$, and for the $2\omega$
q can have two distinct values such that,
\begin{align*}  
I = \frac{\pi|e^3|}{2\hbar^2}\sum_{cv}\frac{1}{\omega^\Sigma_{cv}}
&\left(
\sum_{q\neq (v,c)}
\left[
 \frac{\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{qc}
        \{r^{\text{b}}_{cv}
        r^{\text{c}}_{vq}\}\right]}
        {2\omega^\Sigma_{cv}-\omega^\Sigma_{cq}}
 -\frac{\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vq}
        \{r^{\text{c}}_{qc}
        r^{\text{b}}_{cv}\}\right]}
        {2\omega^\Sigma_{cv}-\omega^\Sigma_{qv}}
\right]\delta(\omega^{\Sigma}_{cv}-\omega)\right.\nonumber\\
-
4&\left.\left[
 \sum_{v^{\prime}\neq v}
  \frac{\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}
        \{r^{\text{b}}_{cv^{\prime}}
        r^{\text{c}}_{v^{\prime}v}\}\right]}
        {2\omega^\Sigma_{cv^{\prime}}-\omega^\Sigma_{cv}}
 -\sum_{c^{\prime}\neq c}
 \frac{\mathrm{Im}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}
        \{r^{\text{c}}_{cc^{\prime}}
        r^{\text{b}}_{c^{\prime}v}\}\right]}
        {2\omega^\Sigma_{c^{\prime}v}-\omega^\Sigma_{cv}}
\right]\delta(\omega^{\Sigma}_{cv}-2\omega)\right).
\end{align*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Generalized derivative
\texorpdfstring{$(\mathbf{r}_{nm}(\mathbf{k}))_{;\mathbf{k}}$} {{rnm};k} for
nonlocal potentials}\label{app:gdernl}

We will derive the generalized derivative
$(\mathbf{r}_{nm}(\mathbf{k}))_{;\mathbf{k}}$ for the case of a nonlocal
potential in the Hamiltonian. We start from Eq. \eqref{conhr},
\begin{align}\label{na_hrdab}
[r^{\mathrm{a}},v^{\mathrm{LDA},\mathrm{b}}]
&= [r^{\mathrm{a}},v^\mathrm{b}] + [r^{\mathrm{a}},v^{\mathrm{nl},\mathrm{b}}]
= \frac{i\hbar}{m_e}\delta_{ab}+ [r^{\mathrm{a}},v^{\mathrm{nl},\mathrm{b}}]
\equiv  
\tau^{\mathrm{a}\mathrm{b}},
\end{align}  
where we used the fact that $[r^\mathrm{a},p^\mathrm{b}]=i\hbar\delta_{ab}$.
Then,
\begin{align}\label{na_hrdab2}
\langle n\mathbf{k}\vert[r^{\mathrm{a}},v^{\mathrm{LDA},\mathrm{b}}]\vert m\mathbf{k}'\rangle
=
\langle n\mathbf{k}\vert\tau^{\mathrm{a}\mathrm{b}}\vert m\mathbf{k}'\rangle
=
\tau^{\mathrm{a}\mathrm{b}}_{nm}(\mathbf{k})\delta(\mathbf{k}-\mathbf{k}')
,
\end{align}
so
\begin{align}\label{na_hrdab3}
\langle n\mathbf{k}\vert[r^{\mathrm{a}}_i,v^{\mathrm{LDA},\mathrm{b}}]\vert m\mathbf{k}'\rangle
+
\langle n\mathbf{k}\vert[r^{\mathrm{a}}_e,v^{\mathrm{LDA},\mathrm{b}}]\vert m\mathbf{k}'\rangle
=
\tau^{\mathrm{a}\mathrm{b}}_{nm}(\mathbf{k})\delta(\mathbf{k}-\mathbf{k}')
,
\end{align}
where the matrix elements of $\tau^{\mathrm{a}\mathrm{b}}_{nm}(\mathbf{k})$ are calculated in  
Sec. \ref{app:calt}.  
From Eq. \eqref{conmri3} and  \eqref{gendev}
\begin{align}\label{na_rip}
\langle n\mathbf{k}\vert[r^{\mathrm{a}}_i,v_\mathrm{LDA}^{\mathrm{b}}]\vert m\mathbf{k}'\rangle
=i\delta(\mathbf{k}-\mathbf{k}')(v_{nm}^{\mathrm{LDA},\mathrm{b}})_{;k^{\mathrm{a}}}
\end{align}
\begin{align}\label{na_ripn}
(v^{\mathrm{LDA},\mathrm{b}}_{nm})_{;k^{\mathrm{a}}}=
\nabla_{k^{\mathrm{a}}}
v^{\mathrm{LDA},\mathrm{b}}_{n m}(\mathbf{k})
-
i
v^{\mathrm{LDA},\mathrm{b}}_{nm}(\mathbf{k})
\left(
\xi^{\mathrm{a}}_{nn}(\mathbf{k})
-
\xi^{\mathrm{a}}_{mm}(\mathbf{k})
\right)
,
\end{align}
and
\begin{align}\label{na_rep}
\langle n\mathbf{k}\vert[r^{\mathrm{a}}_e,v^{\mathrm{LDA},\mathrm{b}}]\vert m\mathbf{k}'\rangle&=
\sum_{\ell\mathbf{k}''}
\bigg(
\langle n\mathbf{k}\vert r^{\mathrm{a}}_e\vert\ell\mathbf{k}''\rangle\langle \ell\mathbf{k}''\vert v^{\mathrm{LDA},\mathrm{b}}\vert m\mathbf{k}'\rangle
-
\langle n\mathbf{k}\vert v^{\mathrm{LDA},\mathrm{b}}\vert\ell\mathbf{k}''\rangle\langle \ell\mathbf{k}''\vert r^{\mathrm{a}}_e\vert m\mathbf{k}'\rangle
\bigg)
\nonumber \\
&=
\sum_{\ell\mathbf{k}''}
\bigg(
(1-\delta_{n\ell})\delta(\mathbf{k}-\mathbf{k}'')\xi^{\mathrm{a}}_{n\ell}
\delta(\mathbf{k}''-\mathbf{k}')v^{\mathrm{LDA},\mathrm{b}}_{\ell m}
-
\delta(\mathbf{k}-\mathbf{k}'')v^{\mathrm{LDA},\mathrm{b}}_{n\ell}
(1-\delta_{\ell m})\delta(\mathbf{k}''-\mathbf{k}')\xi^{\mathrm{a}}_{\ell m}
\bigg)
\nonumber \\
&=
\delta(\mathbf{k}-\mathbf{k}')
\sum_{\ell}
\bigg(
(1-\delta_{n\ell})
\xi^{\mathrm{a}}_{n\ell}
v^{\mathrm{LDA},\mathrm{b}}_{\ell m}
-
(1-\delta_{\ell m})
v^{\mathrm{LDA},\mathrm{b}}_{n\ell}
\xi^{\mathrm{a}}_{\ell m}
\bigg)
\nonumber \\
&=
\delta(\mathbf{k}-\mathbf{k}')
\bigg(
\sum_{\ell}
\bigg(
\xi^{\mathrm{a}}_{n\ell}
v^{\mathrm{LDA},\mathrm{b}}_{\ell m}
-
v^{\mathrm{LDA},\mathrm{b}}_{n\ell}
\xi^{\mathrm{a}}_{\ell m}
\bigg)
+
v^{\mathrm{LDA},\mathrm{b}}_{nm}(\xi^{\mathrm{a}}_{mm}
-
\xi^{\mathrm{a}}_{nn}
)
\bigg)
.
\end{align}
Using Eqs. \eqref{na_rip} and  \eqref{na_rep}
into Eq. \eqref{na_hrdab3} gives
\begin{align}\label{na_rapb}
i\delta(\mathbf{k}-\mathbf{k}')
\bigg(
(v^{\mathrm{LDA},\mathrm{b}}_{nm})_{;k^{\mathrm{a}}}
&
-i
\sum_{\ell}
\bigg(
\xi^{\mathrm{a}}_{n\ell}
v^{\mathrm{LDA},\mathrm{b}}_{\ell m}
-
v^{\mathrm{LDA},\mathrm{b}}_{n\ell}
\xi^{\mathrm{a}}_{\ell m}
\bigg)
-i
v^{\mathrm{LDA},\mathrm{b}}_{nm}(\xi^{\mathrm{a}}_{mm}
-
\xi^{\mathrm{a}}_{nn}
)
\bigg)
=
\tau^{\mathrm{a}\mathrm{b}}_{nm}(\mathbf{k})\delta(\mathbf{k}-\mathbf{k}')
,
\end{align}
then
\begin{align}\label{na_rapb2}
(v^{\mathrm{LDA},\mathrm{b}}_{nm})_{;k^{\mathrm{a}}}&=
-i
\tau^{\mathrm{a}\mathrm{b}}_{nm}
+i
\sum_{\ell}
\bigg(
\xi^{\mathrm{a}}_{n\ell}
v^{\mathrm{LDA},\mathrm{b}}_{\ell m}
-
v^{\mathrm{LDA},\mathrm{b}}_{n\ell}
\xi^{\mathrm{a}}_{\ell m}
\bigg)
+i
v^{\mathrm{LDA},\mathrm{b}}_{nm}(\xi^{\mathrm{a}}_{mm}
-
\xi^{\mathrm{a}}_{nn}
)
,
\end{align}
and from Eq. \eqref{na_ripn},
\begin{align}\label{ncogno}
\nabla_{k^{\mathrm{a}}}v^{\mathrm{LDA},\mathrm{b}}_{nm}=
-i\tau^{\mathrm{a}\mathrm{b}}_{nm}
+i
\sum_{\ell}
\bigg(
\xi^{\mathrm{a}}_{n\ell}
v^{\mathrm{LDA},\mathrm{b}}_{\ell m}
-
v^{\mathrm{LDA},\mathrm{b}}_{n\ell}
\xi^{\mathrm{a}}_{\ell m}
\bigg)
.
\end{align}
Now, there are two cases. We use Eq. \eqref{chon.98}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Case \texorpdfstring{$n=m$}{n=m}}

\begin{align}\label{ntita}
\nabla_{k^{\mathrm{a}}}v^{\mathrm{LDA},\mathrm{b}}_{nn}&=
-i\tau^{\mathrm{a}\mathrm{b}}_{nn}
+i
\sum_{\ell}
\bigg(
\xi^{\mathrm{a}}_{n\ell}
v^{\mathrm{LDA},\mathrm{b}}_{\ell n}
-
v^{\mathrm{LDA},\mathrm{b}}_{n\ell}
\xi^{\mathrm{a}}_{\ell n}
\bigg)
\nonumber\\
&=
-i\tau^{\mathrm{a}\mathrm{b}}_{nn}
-
\sum_{\ell\ne n}
\bigg(
r^{\mathrm{a}}_{n\ell}
\omega^\mathrm{LDA}_{\ell n}
r^\mathrm{b}_{\ell n}
-
\omega^\mathrm{LDA}_{n\ell}
r^\mathrm{b}_{n\ell}
r^{\mathrm{a}}_{\ell n}
\bigg)
\nonumber\\
&=
-i\tau^{\mathrm{a}\mathrm{b}}_{nn}
-
\sum_{\ell\ne n}
\omega^\mathrm{LDA}_{\ell n}
\bigg(
r^{\mathrm{a}}_{n\ell}
r^\mathrm{b}_{\ell n}
-
r^\mathrm{b}_{n\ell}
r^{\mathrm{a}}_{\ell n}
\bigg)
,
\end{align}
since the $\ell=n$ cancels out. This would give the generalization for the
inverse effective mass tensor $(m_n^{-1})_{ab}$ for nonlocal potentials. Indeed,
if we neglect the commutator of $\mathbf{v}^\mathrm{nl}$ in
Eq. \eqref{na_hrdab}, we obtain
$-i\tau^{\mathrm{a}\mathrm{b}}_{nn}=\hbar/m_e\delta_{\mathrm{a}\mathrm{b}}$ thus
obtaining the  familiar expression of $(m_n^{-1})_{ab}$ \cite{ashcroftbook}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Case \texorpdfstring{$n\ne m$}{n!=m}}

\begin{align}\label{nmes}
(v^{\mathrm{LDA},\mathrm{b}}_{nm})_{;k^{\mathrm{a}}}&=
-i\tau^{\mathrm{a}\mathrm{b}}_{nm}
+i  
\sum_{\ell\ne m\ne n}
\bigg(
\xi^{\mathrm{a}}_{n\ell}  
v^{\mathrm{LDA},\mathrm{b}}_{\ell m}
-  
v^{\mathrm{LDA},\mathrm{b}}_{n\ell}
\xi^{\mathrm{a}}_{\ell m}
\bigg)  
+i  
\bigg(
\xi^{\mathrm{a}}_{nm}  
v^{\mathrm{LDA},\mathrm{b}}_{mm}
-  
v^{\mathrm{LDA},\mathrm{b}}_{nm}
\xi^{\mathrm{a}}_{mm}
\bigg)  
\nonumber\\
&\qquad\qquad\qquad\quad\,\,+  
i  
\bigg(
\xi^{\mathrm{a}}_{nn}  
v^{\mathrm{LDA},\mathrm{b}}_{nm}
-  
v^{\mathrm{LDA},\mathrm{b}}_{nn}
\xi^{\mathrm{a}}_{nm}
\bigg)  
+i   
v^{\mathrm{LDA},\mathrm{b}}_{nm}(\xi^{\mathrm{a}}_{mm}
-
\xi^{\mathrm{a}}_{nn}
)  
\nonumber \\
&=
-i\tau^{\mathrm{a}\mathrm{b}}_{nm}
-
\sum_{\ell}
\bigg(
\omega^\mathrm{LDA}_{\ell m}  
r^{\mathrm{a}}_{n\ell}  
r^{\mathrm{b}}_{\ell m}
-
\omega^\mathrm{LDA}_{n\ell}  
r^{\mathrm{b}}_{n\ell}  
r^{\mathrm{a}}_{\ell m}
\bigg)  
+i  
\xi^{\mathrm{a}}_{nm}
(v^{\mathrm{LDA},\mathrm{b}}_{mm}
-  
v^{\mathrm{LDA},\mathrm{b}}_{nn}
)  
\nonumber \\
&=
-i\tau^{\mathrm{a}\mathrm{b}}_{nm}
-
\sum_{\ell}
\bigg(
\omega^\mathrm{LDA}_{\ell m}   
r^{\mathrm{a}}_{n\ell}   
r^{\mathrm{b}}_{\ell m}
-
\omega^\mathrm{LDA}_{n\ell}   
r^{\mathrm{b}}_{n\ell}   
r^{\mathrm{a}}_{\ell m}
\bigg)  
+i   
r^{\mathrm{a}}_{nm}
\Delta^{\mathrm{b}}_{mn}
,
\end{align}   
where we use $\Delta^\mathrm{a}_{mn}$ of Eq. \eqref{eli.13}.
Now, for $n \ne m$, Eqs. \eqref{chon.98},
 \eqref{a_gradw2} and 
 \eqref{nmes} and the chain rule, give
\begin{align}\label{na_rgendevn}
(r^{\mathrm{b}}_{nm})_{;k^{\mathrm{a}}}
&=\left(\frac{v^{\mathrm{LDA},\mathrm{b}}_{nm}}{i\omega^\mathrm{LDA}_{nm}}\right)_{;k^{\mathrm{a}}}
=
\frac{1}
{i\omega^\mathrm{LDA}_{nm}}
\left( 
v^{\mathrm{LDA},\mathrm{b}}_{nm}
\right)_{;k^{\mathrm{a}}}
-
\frac{v^{\mathrm{LDA},\mathrm{b}}_{nm}}
{i(\omega^\mathrm{LDA}_{nm})^2}
\left(
\omega^\mathrm{LDA}_{nm}
\right)_{;k^{\mathrm{a}}}
\nonumber \\
&=
-i\tau^{\mathrm{a}\mathrm{b}}_{nm}
+
\frac{i}{\omega^\mathrm{LDA}_{nm}}
\sum_{\ell}
\bigg(
\omega^\mathrm{LDA}_{\ell m} 
r^{\mathrm{a}}_{n\ell} 
r^{\mathrm{b}}_{\ell m}
-
\omega^\mathrm{LDA}_{n\ell} 
r^{\mathrm{b}}_{n\ell} 
r^{\mathrm{a}}_{\ell m}
\bigg)
+
\frac{r^{\mathrm{a}}_{nm}
\Delta^{\mathrm{b}}_{mn}}
{\omega^\mathrm{LDA}_{nm}}
-
\frac{r^{\mathrm{b}}_{nm}}
{\omega^\mathrm{LDA}_{nm}}
\left(
\omega^\mathrm{LDA}_{nm}
\right)_{;k^{\mathrm{a}}}
\nonumber \\
&=
-i\tau^{\mathrm{a}\mathrm{b}}_{nm}
+
\frac{i}{\omega^\mathrm{LDA}_{nm}}
\sum_{\ell}
\bigg(
\omega^\mathrm{LDA}_{\ell m} 
r^{\mathrm{a}}_{n\ell} 
r^{\mathrm{b}}_{\ell m}
-
\omega^\mathrm{LDA}_{n\ell} 
r^{\mathrm{b}}_{n\ell} 
r^{\mathrm{a}}_{\ell m}
\bigg)
+
\frac{r^{\mathrm{a}}_{nm}
\Delta^{\mathrm{b}}_{mn}}
{\omega^\mathrm{LDA}_{nm}}
-
\frac{r^{\mathrm{b}}_{nm}}
{\omega_{nm}}
\frac{v^{\mathrm{LDA},\mathrm{a}}_{nn}-v^{\mathrm{LDA},\mathrm{a}}_{mm}}{m_e}
\nonumber \\
&=
-i\tau^{\mathrm{a}\mathrm{b}}_{nm}
+
\frac{ 
r^{\mathrm{a}}_{nm}
\Delta^{\mathrm{b}}_{mn}
+r^{\mathrm{b}}_{nm}
\Delta^{\mathrm{a}}_{mn}
}
{\omega^\mathrm{LDA}_{nm}}
+
\frac{i}{\omega^\mathrm{LDA}_{nm}}
\sum_{\ell}
\bigg(
\omega^\mathrm{LDA}_{\ell m} 
r^{\mathrm{a}}_{n\ell} 
r^{\mathrm{b}}_{\ell m}
-
\omega^\mathrm{LDA}_{n\ell} 
r^{\mathrm{b}}_{n\ell} 
r^{\mathrm{a}}_{\ell m}
\bigg)
,
\end{align} 
where the $-i\tau^{\mathrm{a}\mathrm{b}}_{nm}$ term, generalizes the usual expresion of
$\mathbf{r}_{nm;\mathbf{k}}$ for local 
Hamiltonians,\cite{aversaPRB95,nastosPRB05,cabellosPRB09,rashkeevPRB98}
to
the case of a
nonlocal potential in the Hamiltonian.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Layer Case}

To obtain the generalized derivative expressions for the case of the layered
matrix elements ar required by Eq. \eqref{nl.4}, we could start form
Eq. \eqref{na_hrdab} again, and replace $\hat{\mathbf{v}}^\mathrm{LDA}$ by
$\boldsymbol{\mathcal{V}}^\mathrm{LDA}$, to obtain the equivalent of
Eqs. \eqref{ntita} and \eqref{nmes}, for which we need to calculate the new
$\tau^{\mathrm{a}\mathrm{b}}_{nm}$, that is given by
\begin{align}\label{na_hrdab-n}
\mathcal{T}^{\mathrm{a}\mathrm{b}}_{nm}&=
[r^{\mathrm{a}},\mathcal{V}^{\mathrm{LDA},\mathrm{b}}]_{nm}
= [r^{\mathrm{a}},\mathcal{V}^\mathrm{b}]_{nm}+
[r^{\mathrm{a}},\mathcal{V}^{\mathrm{nl},\mathrm{b}}]_{nm}
\nonumber\\
&= \frac{1}{2}
[r^{\mathrm{a}},v^\mathrm{b} C^{\ell}(z)+C^{\ell}(z) v^\mathrm{b}]_{nm} 
+ \frac{1}{2}
[r^{\mathrm{a}},v^{\mathrm{nl},\mathrm{b}}C^{\ell}(z)+C^{\ell}(z) v^{\mathrm{nl},\mathrm{b}}]_{nm} 
\nonumber\\
&=
\Big([r^{\mathrm{a}},v^\mathrm{b}]C^{\ell}(z)\Big)_{nm} 
+
\Big(
[r^{\mathrm{a}},v^{\mathrm{nl},\mathrm{b}}] C^{\ell}(z)\Big)_{nm} 
\nonumber\\
&=
\sum_p[r^{\mathrm{a}},v^\mathrm{b}]_{np}C^{\ell}_{pm} 
+
\sum_p 
[r^{\mathrm{a}},v^{\mathrm{nl},\mathrm{b}}]_{np}C^{\ell}_{pm} 
\nonumber\\
&=
\frac{i\hbar}{m_e}\delta_{\mathrm{a}\mathrm{b}} C^{\ell}_{nm} 
+
\sum_p 
[r^{\mathrm{a}},v^{\mathrm{nl},\mathrm{b}}]_{np}C^{\ell}_{pm} 
.
\end{align} 
For a full-slab calculation, that would correspondo to a bulk calculation as well, $C^{\ell}(z)=1$ and then, $C^{\ell}_{nm}=\delta_{nm}$, and from above expression $\mathcal{T}^{\mathrm{a}\mathrm{b}}_{nm}\to \tau^{\mathrm{a}\mathrm{b}}_{nm}$. Thus, the layered expression for $\mathcal{V}^{\mathrm{LDA},a}_{nm}$ becomes
\begin{align}\label{nmesn}
(\mathcal{V}^{\mathrm{LDA},\mathrm{a}}_{nm})_{;k^{\mathrm{b}}}&=
\frac{\hbar}{m_e}\delta_{\mathrm{a}\mathrm{b}}
C^{\ell}_{nm} 
-i
\sum_p 
[r^{\mathrm{b}},v^{\mathrm{nl},\mathrm{a}}]_{np}C^{\ell}_{pm} 
+i
\sum_{\ell}
\bigg(
r^{\mathrm{b}}_{n\ell}  
\mathcal{V}^{\mathrm{LDA},\mathrm{a}}_{\ell m}
-
\mathcal{V}^{\mathrm{LDA},\mathrm{a}}_{n\ell}   
r^{\mathrm{b}}_{\ell m}
\bigg)  
+i  
r^{\mathrm{b}}_{nm}
\tilde\Delta^{\mathrm{a}}_{mn}
,
\end{align}  
where
\begin{equation}\label{tdel}
\tilde\Delta^{\mathrm{a}}_{mn}
=
\mathcal{V}^{\mathrm{LDA},\mathrm{a}}_{nn}  
-
\mathcal{V}^{\mathrm{LDA},\mathrm{a}}_{mm}  
.
\end{equation}
As mentioned before, the term $[r^{\mathrm{b}},v^{\mathrm{nl},\mathrm{a}}]_{nm}$ calculated in Sec. \ref{app:calt}, is small compared to the other terms, thus we neglect it throwout this work.\cite{valerie} The expression for $C^{\ell}_{nm}$ is calculated in Sec. \ref{app:calpcalc}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Matrix elements of 
\texorpdfstring{$\tau^{\mathrm{a}\mathrm{b}}_{nm}(\mathbf{k})$}{tnm}}
\label{app:calt}

To calculate $\tau^{\mathrm{a}\mathrm{b}}_{nm}$, we first need to calculate
\begin{align}\label{3.1}
\mathcal{L}^{\mathrm{a}\mathrm{b}}_{nm}(\mathbf{k})
=\frac{1}{i\hbar}\langle n\mathbf{k}\vert 
\left[\hat{r}^{\mathrm{a}},\hat{v}^{\mathrm{nl},\mathrm{b}}\right]
\vert m\mathbf{k}'\rangle \delta(\mathbf{k}-\mathbf{k}')
= \frac{1}{\hbar^{2}}
\langle n\mathbf{k}\vert 
\left[\hat{r}^{\mathrm{a}},
\left[\hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}'),\hat{r}^\mathrm{b}
\right]
\right]
\vert m\mathbf{k}'\rangle\delta(\mathbf{k}-\mathbf{k}'),
\end{align} 
for which we need the following triple commutator
\begin{align}\label{3.2}
\left[\hat{r}^{\mathrm{a}},
\left[\hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}'),\hat{r}^\mathrm{b}
\right]
\right]
= \left[\hat{r}^{\mathrm{b}},
\left[\hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}'),\hat{r}^\mathrm{a}
\right]
\right],
\end{align} 
where the right hand side follows from the Jacobi identity, since
$[\hat{r}^\mathrm{a},\hat{r}^\mathrm{b}] = 0$. We expand the triple commutator
as
\begin{align}\label{3.3}
\left[
  \hat{r}^{\mathrm{a}},
\left[
  \hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}'),
  \hat{r}^\mathrm{b}
\right]
\right]
&=\left[
  \hat{r}^{\mathrm{a}},
  \hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}')
  \hat{r}^\mathrm{b}
\right]
-\left[
  \hat{r}^{\mathrm{a}},
  \hat{r}^\mathrm{b}\hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}')
\right]\nonumber\\
&=\left[
  \hat{r}^{\mathrm{a}},
\hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}')
\right]\hat{r}^\mathrm{b}
- \hat{r}^\mathrm{b}
\left[
  \hat{r}^{\mathrm{a}},
  \hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}')
\right]\nonumber\\
&=\hat{r}^{\mathrm{a}}
  \hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}')
  \hat{r}^\mathrm{b}
- \hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}')
  \hat{r}^\mathrm{a}
  \hat{r}^{\mathrm{b}}
- \hat{r}^\mathrm{b}
  \hat{r}^{\mathrm{a}}
  \hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}')
+ \hat{r}^\mathrm{b}
  \hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}')
  \hat{r}^{\mathrm{a}}.
\end{align}
Then,
\begin{align}\label{3.5}
\frac{1}{\hbar^{2}}&
\langle n\mathbf{k}\vert 
\left[
\hat{r}^{\mathrm{a}},
\left[
\hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}'),\hat{r}^\mathrm{b}
\right]
\right]
\vert m\mathbf{k}'\rangle
= \frac{1}{\hbar^{2}}
\int \langle n\mathbf{k}\vert \vert\mathbf{r}\rangle\langle\mathbf{r}\vert 
\left[
\hat{r}^{\mathrm{a}},
\left[
\hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}'),\hat{r}^\mathrm{b}
\right]
\right]
\vert\mathbf{r}'\rangle\langle\mathbf{r}'\vert \vert m\mathbf{k}'\rangle
\delta(\mathbf{k}-\mathbf{k}')\,d\mathbf{r}\,d\mathbf{r}'\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&= \frac{1}{\hbar^{2}}
\int \psi^{*}_{n\mathbf{k}}(\mathbf{r})
\Big(
  r^{\mathrm{a}}V^\mathrm{nl}(\mathbf{r},\mathbf{r}')r^{\prime\mathrm{b}}
- V^\mathrm{nl}(\mathbf{r},\mathbf{r}')r^{\prime\mathrm{a}}r^{\prime\mathrm{b}}
- r^\mathrm{b}r^{\mathrm{a}}V^\mathrm{nl}(\mathbf{r},\mathbf{r}')
+ r^\mathrm{b}V^\mathrm{nl}(\mathbf{r},\mathbf{r}')r^{\prime\mathrm{a}}
\Big)
\psi_{m\mathbf{k}}(\mathbf{r}')
\delta(\mathbf{k}-\mathbf{k}')\,d\mathbf{r}\,d\mathbf{r}'\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&= \frac{1}{\hbar^{2}\Omega}
\sum_{\mathbf{K},\mathbf{K}'}
C^{*}_{n\mathbf{k}}(\mathbf{K})C_{m\mathbf{k}}(\mathbf{K}')
\int e^{-i\mathbf{K}\cdot\mathbf{r}}
\Big(
  r^{\mathrm{a}}V^\mathrm{nl}(\mathbf{r},\mathbf{r}')r^{\prime\mathrm{b}}
- V^\mathrm{nl}(\mathbf{r},\mathbf{r}')r^{\prime\mathrm{a}}r^{\prime\mathrm{b}}
\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&\hspace{7cm} -
  r^\mathrm{b}r^{\mathrm{a}}V^\mathrm{nl}(\mathbf{r},\mathbf{r}')
+ r^\mathrm{b}V^\mathrm{nl}(\mathbf{r},\mathbf{r}')r^{\prime\mathrm{a}}
\Big) 
e^{i\mathbf{K}'\cdot\mathbf{r}'}
\delta(\mathbf{k}-\mathbf{k}')\,d\mathbf{r}\,d\mathbf{r}'.
\end{align} 
We use the following identity,
\begin{align}\label{3.4}
\Big(
 \frac{\partial^{2}}{\partial K^\mathrm{a}\partial K^{\prime\mathrm{b}}}
&+\frac{\partial^{2}}{\partial K^{\prime\mathrm{a}}\partial K^{\prime\mathrm{b}}}
+\frac{\partial^{2}}{\partial K^\mathrm{a}\partial K^\mathrm{b}}
+\frac{\partial^{2}}{\partial K^\mathrm{b}\partial K^{\prime\mathrm{a}}}
\Big)
\int
e^{-i\mathbf{K}\cdot\mathbf{r}}
V^\mathrm{nl}(\mathbf{r},\mathbf{r}')
e^{i\mathbf{K}'\cdot\mathbf{r}'}
\,d\mathbf{r}\,d\mathbf{r}'\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&= \int e^{-i\mathbf{K}\cdot\mathbf{r}}
\Big( 
  r^{\mathrm{a}}V^\mathrm{nl}(\mathbf{r},\mathbf{r}')r^{\prime\mathrm{b}}
- V^\mathrm{nl}(\mathbf{r},\mathbf{r}')r^{\prime\mathrm{a}}r^{\prime\mathrm{b}}
- r^\mathrm{b}r^{\mathrm{a}}V^\mathrm{nl}(\mathbf{r},\mathbf{r}')
+ r^\mathrm{b}V^\mathrm{nl}(\mathbf{r},\mathbf{r}')r^{\prime\mathrm{a}}
\Big)  
e^{i\mathbf{K}'\cdot\mathbf{r}'}\,d\mathbf{r}\,d\mathbf{r}'\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&= \Big(
 \frac{\partial^{2}}{\partial K^\mathrm{a}\partial K^{\prime\mathrm{b}}}
+\frac{\partial^{2}}{\partial K^{\prime\mathrm{a}}\partial K^{\prime\mathrm{b}}}
+\frac{\partial^{2}}{\partial K^\mathrm{a}\partial K^\mathrm{b}}
+\frac{\partial^{2}}{\partial K^\mathrm{b}\partial K^{\prime\mathrm{a}}}
\Big)
\langle\mathbf{K}\vert V^\mathrm{nl} \vert\mathbf{K}'\rangle,
\end{align}
to write
\begin{align}\label{3.7}
\mathcal{L}^{\mathrm{ab}}_{nm}(\mathbf{k})
&= \frac{1}{\hbar^{2}\Omega}
\sum_{\mathbf{K},\mathbf{K}'} 
C^{*}_{n\mathbf{k}}(\mathbf{K})C_{m\mathbf{k}}(\mathbf{K}')
\Big(
 \frac{\partial^{2}}{\partial K^\mathrm{a}\partial K^{\prime\mathrm{b}}}
+\frac{\partial^{2}}{\partial K^{\prime\mathrm{a}}\partial K^{\prime\mathrm{b}}}
+\frac{\partial^{2}}{\partial K^\mathrm{a}\partial K^\mathrm{b}}
+\frac{\partial^{2}}{\partial K^\mathrm{b}\partial K^{\prime\mathrm{a}}}
\Big)
\langle\mathbf{K}\vert V^\mathrm{nl} \vert\mathbf{K}'\rangle.
\end{align} 
The double derivatives with respect to $\mathbf{K}$ and $\mathbf{K}'$ can be
worked out as shown in Sec. \ref{app:vnlme}, to obtain the matrix elements of
$[\hat{V}^\mathrm{nl}(\hat{\mathbf{r}},\hat{\mathbf{r}}'),\hat{r}^\mathrm{b}]$
\cite{olevano}. Therefore, we can obtain the value of the matrix elements of the
triple commutator \cite{valerie}.

With above results we can proceed to evaluate the matrix elements
$\tau_{nm}(\mathbf{k})$. From Eq. \eqref{na_hrdab}
\begin{align}\label{na_hrdabn}
\langle n\mathbf{k}\vert \tau^{\mathrm{a}\mathrm{b}} \vert m\mathbf{k}'\rangle
&=\langle n\mathbf{k}\vert\frac{i\hbar}{m_e}\delta_{ab}\vert m\mathbf{k}'\rangle
+ \langle n\mathbf{k}\vert 
\frac{1}{i\hbar}
\left[r^{\mathrm{a}},v^{\mathrm{nl},\mathrm{b}}\right]
\vert m\mathbf{k}'\rangle\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\mathcal{L}^{\mathrm{a}\mathrm{b}}_{nm}(\mathbf{k})
\delta(\mathbf{k}-\mathbf{k}')
&= \delta(\mathbf{k}-\mathbf{k}')
\left(
  \frac{i\hbar}{m_e}\delta_{ab}\delta_{nm}
+ \mathcal{L}_{nm}^{\mathrm{a}\mathrm{b}}(\mathbf{k})
\right)\nonumber\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tau^{\mathrm{a}\mathrm{b}}_{nm}(\mathbf{k})
 = \tau^{\mathrm{b}\mathrm{a}}_{nm}(\mathbf{k})
&= \frac{i\hbar}{m_e}\delta_{ab}\delta_{nm}
+ \mathcal{L}_{nm}^{\mathrm{a}\mathrm{b}}(\mathbf{k}),
\end{align}
which is an explicit expression that can be numerically calculated.

\stopcontents[chapters]
