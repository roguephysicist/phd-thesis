\section{Coding}\label{code}
In this Appendix we reproduce all the quantities  that should be coded.

Eqs.~\eqref{calvimchiewn}, \eqref{calvimchie2wn}, and \eqref{calvimchiwn}
\eqref{calvimchi2wn}
\begin{eqnarray}\label{c-calvimchiewn}
\mathrm{Im}[\chi_{e,\rma\rmb\rmc,\go}^{s,\ell}] =
-\frac{\pi |e|^3}{2\hbar^2}\sum_{vc\bfk}\sum_{l\neq(v,c)}\frac{1}{\omega^{S}_{cv}}
\left[
\frac{\mathrm{Im}[\mathcal{V}^{\Sigma,\text{a},\ell}_{lc}\{r^{\rmb}_{cv}r^{\rmc}_{vl}\}]}
{(2\go^S_{cv}-\go^S_{cl})} 
-\frac{\mathrm{Im}[\mathcal{V}^{\Sigma,\text{a},\ell}_{vl}\{r^{\rmc}_{lc}r^{\rmb}_{cv}\}]}
{(2\go^S_{cv}-\go^S_{lv})}
\right]\gd(\go^S_{cv}-\go),
\end{eqnarray}  
\begin{eqnarray}\label{c-calvimchie2wn}
\mathrm{Im}[\chi_{e,\rma\rmb\rmc,2\go}^{s,\ell}] =
-\frac{\pi |e|^3}{2\hbar^2}\sum_{vc\bfk}\frac{4}{\omega^{S}_{cv}}
\left[
\sum_{v'\ne
  v}\frac{\mathrm{Im}[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}\{r^{\rmb}_{cv'}r^{\rmc}_{v'v}\}]}
{2\go^S_{cv'}-\go^S_{cv}}
- \sum_{c'\ne
  c}\frac{\mathrm{Im}[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}\{r^{\rmc}_{cc'}r^{\rmb}_{c'v}\}]}
{2\go^S_{c'v}-\go^S_{cv}}
\right]\gd(\go^S_{cv}-2\go),
\end{eqnarray}
\begin{eqnarray}\label{c-calvimchiwn}
\mathrm{Im}[\chi_{i,\text{a}\text{b}\text{c},\omega}^{s,\ell}]
= -\frac{\pi\vert e\vert^3}{2\hbar^2}\sum_{cv\mathbf{k}}\frac{1}{(\omega^{S}_{cv})^{2}}
\left(
\mathrm{Re}\left[r^{\text{b}}_{cv}\left(\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}\right)_{;k^{\text{c}}}\right]
+\frac{\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}r^{\text{b}}_{cv}\right]
\Delta^{\text{c}}_{cv}}{\omega^{S}_{cv}} 
\right)\delta(\omega^{S}_{cv}-\omega),
\end{eqnarray}
and
\begin{eqnarray}\label{c-calvimchi2wn}
\mathrm{Im}[\chi_{i,\text{a}\text{b}\text{c},2\omega}^{s,\ell}] 
=
 -\frac{\pi \vert
   e\vert^{3}}{2\hbar^2}\sum_{vc\mathbf{k}}\frac{4}{(\omega^{S}_{cv})^{2}}
\left(\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}\left(r^{\text{b}}_{cv}\right)_{;k^{\text{c}}}
\right] -
\frac{2\,\mathrm{Re}\left[\mathcal{V}^{\Sigma,\text{a},\ell}_{vc}r^{\text{b}}_{cv}\right]
\Delta^{\text{c}}_{cv}}{\omega^{S}_{cv}}\right)\delta(\omega^{S}_{cv}-2\omega).
\end{eqnarray}

Eq.~\eqref{chon.98}
\begin{eqnarray}\label{c-chon.98}
\bfr_{nm}(\bfk)=\frac{\bfv^\lda_{nm}(\bfk)}{i\go^\lda_{nm}(\bfk)}
\quad\quad n\ne m
,
\end{eqnarray}   
where $\bfv^\lda_{nm}(\bfk)$ include the local and nonlocal parts of the pseudopotential.

Eq.~\eqref{a.1} and \eqref{a.2}
\begin{eqnarray}\label{c-a.1}
\calv^{\gS,\rma,\ell}_{nm}
&=&
\calv^{\lda,\rma,\ell}_{nm}
+
\calv^{S,\rma,\ell}_{nm}
\nonumber\\
\left(
\calv^{\gS,\rma,\ell}_{nm}
\right)_{;k^\rmb}
&=&
\left(
\calv^{\lda,\rma,\ell}_{nm}
\right)_{;k^\rmb}
+
\left(
\calv^{S,\rma,\ell}_{nm}
\right)_{;k^\rmb}
.
\end{eqnarray}
For the LDA term we have
\begin{eqnarray}\label{c-a.2}
\calv^{\lda,\rma,\ell}_{nm}
&=&
\frac{1}{2}\sum_q\left(
v^{\lda,\rma}_{nq}\calc^\ell_{qm}+\calc^\ell_{nq} v^{\lda,\rma}_{qm}
\right)
\nonumber\\
\left(\calv^{\lda,\rma}_{nm}\right)_{;k^\rmb}
&=&
\frac{1}{2}\sum_q\left(
(v^{\lda,\rma}_{nq})_{;k^\rmb}\calc^\ell_{qm}
+ 
v^{\lda,\rma}_{nq}(\calc^\ell_{qm})_{;k^\rmb}
+
(\calc^\ell_{nq})_{;k^\rmb} v^{\lda,\rma}_{qm}
+
\calc^\ell_{nq} (v^{\lda,\rma}_{qm})_{;k^\rmb}
\right)
.
\end{eqnarray} 
 
Eqs.~\eqref{a.3}, \eqref{a.3b} and \eqref{choni.1}
\begin{eqnarray}\label{c-a.3}
(v^{\lda,\rma}_{nm})_{;k^\rmb}
&=&  
im_e\gD^b_{nm}r^\rma_{nm}
+ 
im_e\go^\lda_{nm}(r^\rma_{nm})_{;k^\rmb}
\quad\mathrm{for}\quad n\ne m
.
\end{eqnarray} 

Eqs.~\eqref{eli.13} and \eqref{na_rgendevn},
\begin{eqnarray}\label{c-eli.13}
\gD_{nm}^{\rma}
=
v_{nn}^{\lda,\rma}-v_{mm}^{\lda,\rma}
,
\end{eqnarray}
\begin{eqnarray}\label{c-na_rgendevn}
(r^{\rmb}_{nm})_{;k^{\rma}}
&=&
-i\calt^{\rma\rmb}_{nm}
+
\frac{
r^{\rma}_{nm}
\Delta^{\rmb}_{mn}
+r^{\rmb}_{nm}
\Delta^{\rma}_{mn}
}
{\go^\lda_{nm}}
+
\frac{i}{\go^\lda_{nm}}
\sum_{\ell}
\bigg(
\go^\lda_{\ell m}
r^{\rma}_{n\ell}
r^{\rmb}_{\ell m}
-
\go^\lda_{n\ell}
r^{\rmb}_{n\ell}
r^{\rma}_{\ell m}
\bigg)
,
\end{eqnarray}
with $\calt^{\rma\rmb}_{nm}\approx 0$ for $n\ne m$. Also, 
Eq.~\eqref{a.3c}
\begin{eqnarray}\label{c-a.3c}
(v^{\lda,\rma}_{nn})_{;k^\rmb}
&=&
-i\calt^{\rma\rmb}_{nn}
-
\sum_{\ell\ne n}
\go^\lda_{\ell n}
\bigg( 
r^{\rma}_{n\ell} 
r^\rmb_{\ell n}
+ 
r^\rmb_{n\ell} 
r^{\rma}_{\ell n}
\bigg)
\nonumber\\
&\approx&
\frac{\hbar}{m_e}\gd_{\rma\rmb}
-
\sum_{\ell\ne n}
\go^\lda_{\ell n}
\bigg( 
r^{\rma}_{n\ell} 
r^\rmb_{\ell n}
+ 
r^\rmb_{n\ell} 
r^{\rma}_{\ell n}
\bigg)
,
\end{eqnarray} 
since 
$\calt^{\rma\rmb}_{nn}\approx (\hbar/m_e)\gd_{\rma\rmb}$ for $n=m$.

Eq.~\eqref{a.3b} , \eqref{choni.1} and \eqref{chon.2}
\begin{eqnarray}\label{c-a.3b}
\calv^{S,\rma,\ell}_{nm}
&=&
\frac{1}{2}\sum_q\left( 
v^{S,\rma}_{nq}\calc^\ell_{qm}+\calc^\ell_{nq} v^{S,\rma}_{qm}
\right)
\nonumber\\
\left(\calv^{S,\rma}_{nm}\right)_{;k^\rmb}
&=&
\frac{1}{2}\sum_q\left(
(v^{S,\rma}_{nq})_{;k^\rmb}\calc^\ell_{qm}
+  
v^{S,\rma}_{nq}(\calc^\ell_{qm})_{;k^\rmb}
+
(\calc^\ell_{nq})_{;k^\rmb} v^{S,\rma}_{qm}
+
\calc^\ell_{nq} (v^{S,\rma}_{qm})_{;k^\rmb}
\right)
,
\end{eqnarray}  
with (Eqs.~\eqref{chon.2} and \eqref{choni.1})
\begin{eqnarray}\label{c-chon.2} 
v^{S,\rma}_{nm}=i\gD f_{mn}r^\rma_{nm}
,
\end{eqnarray}
\begin{eqnarray}\label{c-choni.1}
(v^{S,\rma}_{nm})_{;k^\rmb}=i\gD f_{mn}
(r^\rma_{nm})_{;k^\rmb}
.
\end{eqnarray}

Eq.~\eqref{eni.4} and \eqref{a.7}
\begin{eqnarray}\label{c-eni.4}
\calc^\ell_{nm}(\bfk)=
\sum_{\bfG,\bfG'} A^*_{n\bfk}(\bfG')  A_{m\bfk}(\bfG)
\gd_{\bfG_\parallel \bfG'_\parallel}
f_\ell(G_\perp-G'_\perp)
.
\end{eqnarray} 
\begin{eqnarray}\label{c-a.7}
 (\calc^\ell_{nm})_{;\bfk}
&=&
i\sum_{q\ne nm}
\left(
r_{nq}^\rma
\calc^\ell_{qm}
-
\calc^\ell_{nq}
r_{qm}^\rma
\right)
+ir_{nm}^\rma(\calc^\ell_{mm}-\calc^\ell_{nn})
.
\end{eqnarray} 
$\gD$ is the value of the scissors shift, not to be confused with $\gD_{nm}$. 
$\calc^\ell_{nm}(\bfk)$ must be coded in the same subroutine of $\calbv^\ell_{nm}$
 calculated with Eq.~\eqref{eni.2}
